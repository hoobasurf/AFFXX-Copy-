<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Inscription</title>
<link rel="stylesheet" href="style.css" />
</head>
<body>

<div class="container">
  <h1>Inscription</h1>
  <input type="email" id="email" placeholder="Email" />
  <input type="password" id="password" placeholder="Mot de passe" />
  <input type="text" id="pseudo" placeholder="Pseudo" />
  <input type="number" id="age" placeholder="Âge" />
  <input type="text" id="location" placeholder="Ville" />
  <textarea id="description" placeholder="Description..."></textarea>

  <input type="file" id="photos" accept="image/*" multiple />
  <div id="photosPreview"></div>

  <div class="salles">
    <button class="salle-btn" data-value="serieux">Sérieux</button>
    <button class="salle-btn" data-value="amicale">Amicale</button>
    <button class="salle-btn" data-value="fun">Fun</button>
  </div>

  <button id="signupBtn">Inscription</button>
  <button id="loginBtn">Connexion</button>
</div>

<div id="lightbox">
  <img id="lightboxImg" />
</div>

<div id="vortexOverlay">
  <div id="whiteFlash"></div>
</div>

<script type="module">
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";
import { app } from "./firebase.js";

const auth = getAuth(app);
const db = getDatabase(app);

const email = document.getElementById("email");
const password = document.getElementById("password");
const pseudo = document.getElementById("pseudo");
const age = document.getElementById("age");
const locationInput = document.getElementById("location");
const description = document.getElementById("description");
const photosInput = document.getElementById("photos");
const preview = document.getElementById("photosPreview");
const signupBtn = document.getElementById("signupBtn");
const loginBtn = document.getElementById("loginBtn");
const lightbox = document.getElementById("lightbox");
const lightboxImg = document.getElementById("lightboxImg");
const vortexOverlay = document.getElementById("vortexOverlay");
const whiteFlash = document.getElementById("whiteFlash");

let uploadedPhotos = [];

// --- prévisualisation des photos ---
photosInput.addEventListener("change", e => {
  preview.innerHTML = "";
  uploadedPhotos = [];
  [...e.target.files].slice(0, 5).forEach(file => {
    const reader = new FileReader();
    reader.onload = ev => {
      const img = document.createElement("img");
      img.src = ev.target.result;
      img.addEventListener("click", () => {
        lightboxImg.src = ev.target.result;
        lightbox.style.display = "flex";
      });
      preview.appendChild(img);
    };
    reader.readAsDataURL(file);
    uploadedPhotos.push(file);
  });
});

lightbox.addEventListener("click", () => {
  lightbox.style.display = "none";
  lightboxImg.src = "";
});

// --- sélection des salles ---
const salleBtns = document.querySelectorAll(".salle-btn");
let selectedRooms = [];
salleBtns.forEach(btn => {
  btn.addEventListener("click", () => {
    const val = btn.dataset.value;
    if (selectedRooms.includes(val)) {
      selectedRooms = selectedRooms.filter(r => r !== val);
      btn.classList.remove("active");
    } else {
      selectedRooms.push(val);
      btn.classList.add("active");
    }
  });
});

function playVortexAndRedirect() {
  vortexOverlay.style.display = "flex";
  setTimeout(() => {
    whiteFlash.style.opacity = "1";
    setTimeout(() => window.location.href = "page2.html", 400);
  }, 1800);
}

// --- bouton inscription original ---
signupBtn.addEventListener("click", async () => {
  if (!email.value || !password.value) {
    alert("Email et mot de passe requis");
    return;
  }

  try {
    const userCred = await createUserWithEmailAndPassword(auth, email.value, password.value);
    const user = userCred.user;

    // 🔹 Tableau de photos seulement si upload
    const photoURLs = uploadedPhotos.length > 0 
      ? uploadedPhotos.map(file => URL.createObjectURL(file))
      : [];

    await set(ref(db, "users/" + user.uid), {
      email: email.value,
      pseudo: pseudo.value,
      age: age.value,
      location: locationInput.value,
      description: description.value,
      rooms: selectedRooms,
      photos: photoURLs, // ← vide si aucune photo
      online: false,
      gender: "girl"
    });

    playVortexAndRedirect();

  } catch (e) {
    alert("Erreur: " + e.message);
  }
});

// --- bouton connexion ---
loginBtn.addEventListener("click", async () => {
  try {
    await signInWithEmailAndPassword(auth, email.value, password.value);
    playVortexAndRedirect();
  } catch (e) {
    alert("Erreur: " + e.message);
  }
});
</script>
</body>
</html>
