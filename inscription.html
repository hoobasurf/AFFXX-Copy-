<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Inscription</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="style.css">
</head>
<body>

<div class="container">
  <h1>Inscription</h1>

  <input type="email" id="email" placeholder="Adresse e-mail" required>
  <input type="password" id="password" placeholder="Mot de passe" required>
  <input type="text" id="pseudo" placeholder="Pseudo">
  <input type="number" id="age" placeholder="Âge">
  <input type="text" id="location" placeholder="Lieu">
  <textarea id="description" placeholder="Description"></textarea>

  <button id="signupBtn" class="edit-btn">S’inscrire</button>
  <button id="loginBtn" class="edit-btn">Se connecter</button>
</div>

<script type="module">
import { app, auth, clearLocalSession } from "./firebase.js";
import {
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword
} from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
import {
  getDatabase,
  ref,
  set
} from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

const db = getDatabase(app);
const email = document.getElementById("email");
const password = document.getElementById("password");
const pseudo = document.getElementById("pseudo");
const age = document.getElementById("age");
const locationInput = document.getElementById("location");
const description = document.getElementById("description");
const signupBtn = document.getElementById("signupBtn");
const loginBtn = document.getElementById("loginBtn");

/* --- INSCRIPTION --- */
signupBtn.addEventListener("click", async () => {
  if (!email.value || !password.value) {
    alert("Email et mot de passe requis");
    return;
  }

  // ✅ Nettoie les caches locaux (empêche le bug 'email déjà utilisé')
  await clearLocalSession();

  try {
    const cred = await createUserWithEmailAndPassword(auth, email.value, password.value);
    const user = cred.user;

    await set(ref(db, "users/" + user.uid), {
      pseudo: pseudo.value || "",
      age: age.value || "",
      location: locationInput.value || "",
      description: description.value || "",
      photos: [],
      rooms: [],
      online: true
    });

    alert("✅ Inscription réussie !");
    window.location.href = "page2.html";

  } catch (e) {
    console.error("Erreur inscription :", e);
    if (e.code === "auth/email-already-in-use") {
      alert("Cet e-mail est déjà utilisé. Essaie de te connecter.");
    } else {
      alert("Erreur : " + e.message);
    }
  }
});

/* --- CONNEXION --- */
loginBtn.addEventListener("click", async () => {
  if (!email.value || !password.value) {
    alert("Email et mot de passe requis");
    return;
  }

  try {
    await signInWithEmailAndPassword(auth, email.value, password.value);
    alert("Connexion réussie ✅");
    window.location.href = "page2.html";
  } catch (e) {
    alert("Erreur de connexion : " + e.message);
  }
});
</script>

</body>
</html>
