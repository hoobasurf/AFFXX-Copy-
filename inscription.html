<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Inscription</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500&display=swap" rel="stylesheet"/>
<style>
body {
  margin: 0;
  font-family: 'Orbitron', sans-serif;
  background: url("ville.jpg") no-repeat center center/cover;
  color: #fff;
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  overflow: hidden;
}
.container {
  background: rgba(0,0,0,0.4);
  padding: 20px;
  border-radius: 15px;
  width: 95%;
  max-width: 500px;
  box-shadow: 0 0 20px #ff66cc;
  text-align: center;
  transition: transform 0.6s ease-in-out, opacity 0.6s ease-in-out;
}
h1 {
  color: #ff66cc;
  text-shadow: 0 0 10px #ff66cc;
}
input, textarea {
  width: 100%;
  margin: 10px 0;
  padding: 10px;
  border-radius: 8px;
  border: 2px solid #ff66cc;
  background: rgba(0,0,0,0.5);
  color: #fff;
}
button {
  margin: 10px;
  padding: 10px 20px;
  border-radius: 8px;
  border: 2px solid #ff66cc;
  background: rgba(0,0,0,0.4);
  color: #fff;
  cursor: pointer;
  font-size: 1em;
  text-transform: uppercase;
  box-shadow: 0 0 10px #ff66cc, 0 0 20px #ff66cc inset;
  transition: 0.3s;
}
button:hover { box-shadow: 0 0 20px #ff66cc, 0 0 30px #ff66cc inset; }

.rooms-btns {
  display: flex;
  justify-content: center;
  gap: 10px;
  margin: 10px 0;
}
.rooms-btns button {
  background: rgba(0,0,0,0.4);
  border: 2px solid #ff66cc;
  color: #fff;
  padding: 8px 15px;
  border-radius: 8px;
  cursor: pointer;
  transition: 0.3s;
}
.rooms-btns button.selected {
  background: #ff66cc;
  color: #000;
  box-shadow: 0 0 15px #ff66cc;
}

.photos-preview {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 10px;
  margin-top: 10px;
}
.photos-preview img {
  width: 70px;
  height: 70px;
  object-fit: cover;
  border-radius: 8px;
  border: 2px solid #ff66cc;
  cursor: pointer;
  transition: transform 0.2s;
}
.photos-preview img:hover { transform: scale(1.2); }

.lightbox {
  display: none;
  position: fixed;
  z-index: 1000;
  top:0; left:0;
  width:100%; height:100%;
  background: rgba(0,0,0,0.9);
  justify-content: center;
  align-items: center;
}
.lightbox img {
  max-width: 90%;
  max-height: 90%;
  border-radius: 10px;
  box-shadow: 0 0 25px #ff66cc;
}
</style>
</head>
<body>
<div class="container" id="container">
  <h1>Inscription</h1>
  <input type="email" id="email" placeholder="Email">
  <input type="password" id="password" placeholder="Mot de passe">
  <input type="text" id="pseudo" placeholder="Pseudo">
  <input type="number" id="age" placeholder="Âge">
  <input type="text" id="location" placeholder="Lieu">
  <textarea id="description" placeholder="Description..."></textarea>

  <div class="rooms-btns" id="roomsBtns">
    <button data-value="serieux">Sérieux</button>
    <button data-value="amicale">Amicale</button>
    <button data-value="fun">Fun</button>
  </div>

  <label for="photos">Ajoute jusqu’à 5 photos :</label>
  <input type="file" id="photos" accept="image/*" multiple>
  <div class="photos-preview" id="photosPreview"></div>

  <button id="signupBtn">S’inscrire</button>
  <button id="loginBtn">Se connecter</button>
</div>

<div class="lightbox" id="lightbox">
  <img id="lightboxImg" src="">
</div>

<script type="module">
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";
import { app } from "./firebase.js";

const auth = getAuth(app);
const db = getDatabase(app);

const container = document.getElementById("container");
const email = document.getElementById("email");
const password = document.getElementById("password");
const pseudo = document.getElementById("pseudo");
const age = document.getElementById("age");
const locationInput = document.getElementById("location");
const description = document.getElementById("description");
const photosInput = document.getElementById("photos");
const photosPreview = document.getElementById("photosPreview");

const lightbox = document.getElementById("lightbox");
const lightboxImg = document.getElementById("lightboxImg");

const roomsBtns = document.querySelectorAll("#roomsBtns button");
let selectedRooms = [];
roomsBtns.forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const value = btn.dataset.value;
    if(selectedRooms.includes(value)){
      selectedRooms = selectedRooms.filter(r=>r!==value);
      btn.classList.remove("selected");
    } else if(selectedRooms.length<3){
      selectedRooms.push(value);
      btn.classList.add("selected");
    }
  });
});

let uploadedPhotos = [];
photosInput.addEventListener("change", e=>{
  photosPreview.innerHTML="";
  uploadedPhotos=[];
  [...e.target.files].slice(0,5).forEach(file=>{
    const reader = new FileReader();
    reader.onload = ev=>{
      const img = document.createElement("img");
      img.src = ev.target.result;
      img.addEventListener("click", ()=>{
        lightboxImg.src = ev.target.result;
        lightbox.style.display="flex";
      });
      photosPreview.appendChild(img);
    };
    reader.readAsDataURL(file);
    uploadedPhotos.push(file);
  });
});

lightbox.addEventListener("click", ()=>{
  lightbox.style.display="none";
  lightboxImg.src="";
});

signupBtn.addEventListener("click", ()=>{
  if(selectedRooms.length===0){ alert("Choisis au moins une salle"); return; }

  // Zoom avant
  container.style.transform="scale(2)";
  container.style.opacity="0";

  setTimeout(async ()=>{
    try{
      const userCred = await createUserWithEmailAndPassword(auth,email.value,password.value);
      const user = userCred.user;

      // Stocker les photos localement (DataURL) pour éviter Storage
      const photosData = await Promise.all(uploadedPhotos.map(file=>{
        return new Promise(res=>{
          const reader = new FileReader();
          reader.onload = e=>res(e.target.result);
          reader.readAsDataURL(file);
        });
      }));

      await set(ref(db,"users/"+user.uid),{
        email: email.value,
        pseudo: pseudo.value,
        age: age.value,
        location: locationInput.value,
        description: description.value,
        rooms: selectedRooms,
        photos: photosData
      });

      window.location.replace("page2.html"); // direct page2 sans flash
    } catch(e){
      alert("Erreur : "+e.message);
      container.style.transform="scale(1)";
      container.style.opacity="1";
    }
  }, 0);
});

loginBtn.addEventListener("click", async ()=>{
  try{
    await signInWithEmailAndPassword(auth,email.value,password.value);
    window.location.replace("page2.html");
  }catch(e){ alert("Erreur : "+e.message);}
});
</script>
</body>
</html>
