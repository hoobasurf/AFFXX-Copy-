<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mon Profil</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500&display=swap" rel="stylesheet"/>
<style>
/* --- VISUEL: je n'ai pas modifié ton look, j'ai juste gardé le style que tu avais --- */
body {
  margin: 0;
  font-family: 'Orbitron', sans-serif;
  background: url("planete-magique.jpg") no-repeat center center/cover;
  color: #fff;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  min-height: 100vh;
  padding: 20px 0;
}
.container {
  background: rgba(0,0,0,0.6);
  padding: 25px;
  border-radius: 15px;
  width: 90%;
  max-width: 500px;
  box-shadow: 0 0 20px #ff66cc;
  text-align: center;
}
h1 {
  color: #ff66cc;
  text-shadow: 0 0 10px #ff66cc;
  margin-bottom: 20px;
}
.info div { margin: 8px 0; text-align: center; }
.main-photo {
  width: 100%;
  max-height: 300px;
  object-fit: cover;
  border-radius: 10px;
  margin-bottom: 15px;
  border: 2px solid #ff66cc;
  cursor: pointer;
}
.photos {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  justify-content: center;
  margin: 15px 0;
}
.photos img {
  width: 70px;
  height: 70px;
  object-fit: cover;
  border-radius: 8px;
  border: 2px solid #ff66cc;
  cursor: pointer;
  transition: transform 0.2s;
}
.photos img:hover { transform: scale(1.1); }

/* Lightbox */
.lightbox {
  display: none;
  position: fixed;
  z-index: 10000;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.9);
  justify-content: center;
  align-items: center;
}
.lightbox img {
  max-width: 90%;
  max-height: 90%;
  border-radius: 10px;
  box-shadow: 0 0 25px #ff66cc;
}

.room-btn {
  padding: 10px 20px;
  margin: 10px 5px;
  border: 2px solid #ff66cc;
  background: rgba(0,0,0,0.4);
  color: #fff;
  border-radius: 8px;
  cursor: pointer;
  text-transform: uppercase;
  font-size: 0.9em;
  box-shadow: 0 0 10px #ff66cc, 0 0 20px #ff66cc inset;
  transition: 0.3s;
}
.room-btn:hover {
  box-shadow: 0 0 20px #ff66cc, 0 0 30px #ff66cc inset;
}

/* petit message si profil introuvable */
.notice {
  margin-top: 12px;
  background: rgba(255,255,255,0.06);
  padding: 12px;
  border-radius: 8px;
  color: #ffd6ef;
  border: 1px solid rgba(255,102,204,0.1);
}
</style>
</head>
<body>
  <div class="container" id="mainContainer">
    <h1>Mon Profil</h1>

    <div class="info" id="infoBlock">
      <div><strong>Pseudo :</strong> <span id="pseudo">Non renseigné</span></div>
      <div><strong>Âge :</strong> <span id="age">Non renseigné</span></div>
      <div><strong>Lieu :</strong> <span id="location">Non renseigné</span></div>
      <div><strong>Description :</strong> <span id="description">Non renseignée</span></div>
    </div>

    <img id="mainPhoto" class="main-photo" src="" alt="Photo principale" style="display:none;">

    <div class="photos" id="photosContainer"></div>

    <div id="roomButtons"></div>

    <div id="fallbackNotice" class="notice" style="display:none;">
      Profil introuvable localement. Si tu veux, clique <button id="goIns" style="margin-left:8px;padding:6px 10px;border-radius:6px;border:1px solid #ff66cc;background:transparent;color:#ff66cc;cursor:pointer">Inscription</button> pour (re-)créer un compte.
    </div>
  </div>

  <div class="lightbox" id="lightbox">
    <img id="lightboxImg" src="">
  </div>

<script type="module">
(async function(){
  // DOM refs
  const pseudoSpan = document.getElementById("pseudo");
  const ageSpan = document.getElementById("age");
  const locationSpan = document.getElementById("location");
  const descSpan = document.getElementById("description");
  const mainPhoto = document.getElementById("mainPhoto");
  const photosContainer = document.getElementById("photosContainer");
  const roomButtons = document.getElementById("roomButtons");
  const fallbackNotice = document.getElementById("fallbackNotice");
  const goInsBtn = document.getElementById("goIns");
  const lightbox = document.getElementById("lightbox");
  const lightboxImg = document.getElementById("lightboxImg");

  goInsBtn.addEventListener("click", ()=>{ window.location.href = "inscription.html"; });

  // Utilitaires pour trouver les données utilisateur (plusieurs sauvegardes possibles)
  function loadFromLocalStorage(){
    // clés possibles que tu as utilisées dans différents codes : "userData", "selectedUser", "profilSelectionne", ...
    const keys = ["userData","selectedUser","profilSelectionne","profilSelectionné","profil_selectionne"];
    for(const k of keys){
      const raw = localStorage.getItem(k);
      if(raw){
        try { const parsed = JSON.parse(raw); if(parsed && (parsed.pseudo || parsed.name)) return parsed; } catch(e){}
      }
    }

    // cas : tu as stocké pseudo seul et allUsers (tableau)
    const allRaw = localStorage.getItem("allUsers");
    const pseudoLocal = localStorage.getItem("pseudo");
    if(allRaw && pseudoLocal){
      try {
        const all = JSON.parse(allRaw);
        if(Array.isArray(all)){
          const found = all.find(u => u.pseudo === pseudoLocal || u.name === pseudoLocal);
          if(found) return found;
        } else if (typeof all === "object") {
          // parfois allUsers est un objet {uid: {...}}
          for(const k in all){
            const u = all[k];
            if(u && (u.pseudo === pseudoLocal || u.name === pseudoLocal)) return u;
          }
        }
      } catch(e){}
    }

    // cas: you stored "profilSelectionne" as stringified object name
    const profSel = localStorage.getItem("profilSelectionne");
    if(profSel){
      try { const p = JSON.parse(profSel); if(p) return p;} catch(e){}
    }

    return null;
  }

  function normalizeProfile(raw){
    // normalise différents formats rencontrés
    if(!raw) return null;
    const profile = {};
    profile.pseudo = raw.pseudo || raw.name || raw.displayName || raw.username || "Non renseigné";
    profile.age = raw.age || raw.Age || raw.years || "";
    profile.location = raw.location || raw.city || raw.lieu || "";
    profile.description = raw.description || raw.desc || raw.bio || "";
    // photos peut être "photos" (array) ou "photo" (single) ou "photosData" etc.
    if(Array.isArray(raw.photos) && raw.photos.length) profile.photos = raw.photos.slice(0,5);
    else if(Array.isArray(raw.photos) && !raw.photos.length) profile.photos = [];
    else if(typeof raw.photos === "string" && raw.photos) profile.photos = [raw.photos];
    else if(raw.photo) profile.photos = [raw.photo];
    else if(raw.image) profile.photos = [raw.image];
    else profile.photos = [];
    // rooms
    if(Array.isArray(raw.rooms)) profile.rooms = raw.rooms;
    else if(typeof raw.rooms === "string") {
      try {
        const parsed = JSON.parse(raw.rooms);
        profile.rooms = Array.isArray(parsed) ? parsed : [raw.rooms];
      } catch(e){
        profile.rooms = raw.rooms ? [raw.rooms] : [];
      }
    } else profile.rooms = raw.rooms || raw.roomsSelected || [];
    return profile;
  }

  // render function
  function renderProfile(profileObj, options = { isOwn:false, source:"local" }){
    const p = normalizeProfile(profileObj);
    pseudoSpan.textContent = p.pseudo || "Non renseigné";
    ageSpan.textContent = p.age || "Non renseigné";
    locationSpan.textContent = p.location || "Non renseigné";
    descSpan.textContent = p.description || "Non renseignée";

    // main photo: show first if exists, else hide
    if(p.photos && p.photos.length > 0){
      mainPhoto.src = p.photos[0];
      mainPhoto.style.display = "";
      mainPhoto.onclick = () => {
        lightboxImg.src = p.photos[0];
        lightbox.style.display = "flex";
      };
    } else {
      mainPhoto.style.display = "none";
    }

    // thumbnails
    photosContainer.innerHTML = "";
    if(p.photos && p.photos.length>0){
      p.photos.forEach(url => {
        const img = document.createElement("img");
        img.src = url;
        img.alt = "photo";
        img.addEventListener("click", ()=> {
          lightboxImg.src = url;
          lightbox.style.display = "flex";
        });
        photosContainer.appendChild(img);
      });
    }

    // rooms => only the ones chosen
    roomButtons.innerHTML = "";
    const salleMapping = { serieux: "authentique.html", amicale: "amicale.html", fun: "fun.html" };
    if(Array.isArray(p.rooms) && p.rooms.length > 0){
      p.rooms.forEach(r => {
        const key = (""+r).toLowerCase();
        if(salleMapping[key]){
          const btn = document.createElement("button");
          btn.className = "room-btn";
          // affichage propre
          btn.textContent = key.charAt(0).toUpperCase() + key.slice(1);
          btn.addEventListener("click", ()=> { window.location.href = salleMapping[key]; });
          roomButtons.appendChild(btn);
        }
      });
    }
  }

  // 1) Essayer localStorage (priorité)
  const localRaw = loadFromLocalStorage();
  if(localRaw){
    renderProfile(localRaw, {isOwn:true, source:"local"});
    fallbackNotice.style.display = "none";
    return; // ok, on a ce qu'il faut
  }

  // 2) Si pas local, essayer Firebase si firebase.js existe et est importable
  let firebaseAvailable = false;
  try {
    // tente d'importer ./firebase.js (fichier que tu dois avoir dans ton projet)
    const fbModule = await import('./firebase.js').catch(()=>null);
    if(fbModule && fbModule.app){
      // on a un export app dans firebase.js (conforme à ton ancien code)
      const { getAuth, onAuthStateChanged } = await import('https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js');
      const { getDatabase, ref, get } = await import('https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js');
      const app = fbModule.app;
      const auth = getAuth(app);
      const db = getDatabase(app);

      firebaseAvailable = true;
      // utilise onAuthStateChanged pour obtenir l'utilisateur
      onAuthStateChanged(auth, async (user) => {
        if(!user){
          // pas connecté : n'auto-redirect pas (évite boucle), montre notice
          fallbackNotice.style.display = "";
          return;
        }
        try {
          const snap = await get(ref(db, "users/" + user.uid));
          if(snap.exists()){
            renderProfile(snap.val(), { isOwn:true, source:"firebase" });
            fallbackNotice.style.display = "none";
          } else {
            // pas de noeud user : montre notice
            fallbackNotice.style.display = "";
          }
        } catch(e){
          console.error("Erreur lecture DB:", e);
          fallbackNotice.style.display = "";
        }
      });
      return;
    }
  } catch(e){
    console.warn("firebase import failed:", e);
    firebaseAvailable = false;
  }

  // 3) si rien trouvé : afficher message et bouton vers inscription (pas de redirect automatique)
  fallbackNotice.style.display = "";
})(); // IIFE end

// lightbox fermer au clic
document.getElementById("lightbox").addEventListener("click", ()=>{
  document.getElementById("lightbox").style.display = "none";
  document.getElementById("lightboxImg").src = "";
});
</script>
</body>
</html>
