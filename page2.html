<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>Page2</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500&display=swap" rel="stylesheet">
<style>
* { box-sizing:border-box; margin:0; padding:0; }
html, body { height:100%; width:100%; font-family:'Orbitron',sans-serif; background:url('planete-romantique.jpg') no-repeat center center/cover; color:white; overflow:hidden; }
body::before { content:""; position:fixed; top:0; left:0; width:100%; height:100%; background: radial-gradient(circle at center, rgba(255,0,255,0.05), transparent 70%); z-index:1; pointer-events:none; }

#myProfile { z-index:3; position: relative; text-align:center; margin-top:10px; cursor:pointer; }
#myProfile img { width:100px; height:100px; border-radius:50%; border:3px solid #ff66cc; box-shadow:0 0 15px #ff66cc; object-fit:cover; }
#myProfile div { margin-top:8px; font-size:1.2em; color:#ff66cc; }

.carousel-container { z-index:2; position: relative; width:100%; height:calc(100% - 120px); overflow:hidden; display:flex; align-items:center; }
.carousel { display:flex; overflow-x:auto; scroll-snap-type:x mandatory; -webkit-overflow-scrolling:touch; gap:40px; padding:40px; }
.carousel::-webkit-scrollbar { display:none; }

.card { scroll-snap-align:center; flex:0 0 150px; background:rgba(0,0,0,0.5); border-radius:16px; padding:15px; text-align:center; transition: transform .3s, box-shadow .3s; cursor:pointer; position:relative; }
.card img { width:90px; height:90px; border-radius:50%; object-fit:cover; margin-bottom:10px; border:3px solid; }
.girl img { border-color:#ff66cc; box-shadow:0 0 12px #ff66cc; }
.boy img { border-color:#9933ff; box-shadow:0 0 12px #9933ff; }
.name { font-size:1.1em; margin-bottom:5px; }
</style>
</head>
<body>

<div id="myProfile">
  <img id="miniProfilePic" src="" alt="Mon profil">
  <div id="pseudoMini">Utilisateur</div>
</div>

<div class="carousel-container">
  <div class="carousel" id="carousel"></div>
</div>

<script type="module">
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";
import { app } from "./firebase.js";

const auth = getAuth(app);
const db = getDatabase(app);

const miniProfilePic = document.getElementById("miniProfilePic");
const pseudoMini = document.getElementById("pseudoMini");
const carousel = document.getElementById("carousel");

let currentUserUid = null;

// --- Auth et mini-profil ---
onAuthStateChanged(auth, async user => {
  if(!user){ window.location.href="inscription.html"; return; }
  currentUserUid = user.uid;

  const userRef = ref(db,"users/"+currentUserUid);
  onValue(userRef, snap=>{
    if(!snap.exists()) return;
    const data = snap.val();
    pseudoMini.textContent = data.pseudo || "Utilisateur";
    const photo = data.photos && Array.isArray(data.photos) && data.photos[0] ? data.photos[0] : '';
    if(photo) miniProfilePic.src = photo;
  });

  // --- Carrousel uniquement vrais utilisateurs ---
  const allUsersRef = ref(db,"users");
  onValue(allUsersRef, snap=>{
    carousel.innerHTML = "";
    if(!snap.exists()) return;
    const allUsers = snap.val();
    let hasOnline = false;

    Object.entries(allUsers).forEach(([uid, u])=>{
      // filtrage strict : pas soi-même, online=true, pseudo et photo existants
      if(uid === currentUserUid) return;
      if(!u.online) return;
      if(!u.photos || u.photos.length === 0) return;
      if(!u.pseudo || u.pseudo.trim() === "") return;

      hasOnline = true;

      const card = document.createElement("div");
      card.className = "card " + (u.gender || "girl");
      card.dataset.uid = uid;

      card.innerHTML = `
        <img src="${u.photos[0]}" alt="${u.pseudo}">
        <div class="name">${u.pseudo}</div>
      `;

      carousel.appendChild(card);
    });

    if(!hasOnline){
      const emptyMsg = document.createElement("div");
      emptyMsg.style.textAlign="center";
      emptyMsg.style.width="100%";
      emptyMsg.style.color="#ff66cc";
      emptyMsg.textContent = "Aucun utilisateur en ligne pour le moment...";
      carousel.appendChild(emptyMsg);
    }
  });
});

// --- clic sur ma photo ouvre page précédente ou profil ---
miniProfilePic.addEventListener("click", ()=>window.location.href="authentique.html");
</script>
</body>
</html>
