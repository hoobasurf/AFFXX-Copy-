<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Profil Utilisateur</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500&display=swap" rel="stylesheet"/>
<style>
body {
  margin:0;
  font-family: 'Orbitron', sans-serif;
  background: url("planete-magique.jpg") no-repeat center center/cover;
  color: #fff;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  min-height: 100vh;
  padding: 20px 0;
}
.container {
  background: rgba(0,0,0,0.6);
  padding: 25px;
  border-radius: 15px;
  width: 90%;
  max-width: 500px;
  box-shadow: 0 0 20px #ff66cc;
  text-align: center;
  position: relative;
}
h1 {
  color: #ff66cc;
  text-shadow: 0 0 10px #ff66cc;
  margin-bottom: 20px;
}
.info div { margin: 8px 0; text-align:left; }
.main-photo {
  width: 100%;
  max-height: 300px;
  object-fit: cover;
  border-radius: 10px;
  margin-bottom: 15px;
  border: 2px solid #ff66cc;
  cursor: pointer;
}
.photos {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  justify-content: center;
  margin: 15px 0;
}
.photos img {
  width: 70px;
  height: 70px;
  object-fit: cover;
  border-radius: 8px;
  border: 2px solid #ff66cc;
  cursor: pointer;
  transition: transform 0.2s;
}
.photos img:hover { transform: scale(1.1); }

/* Lightbox */
.lightbox {
  display:none;
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background: rgba(0,0,0,0.9);
  justify-content:center;
  align-items:center;
  z-index:1000;
}
.lightbox img { max-width:90%; max-height:90%; border-radius:10px; box-shadow:0 0 25px #ff66cc; }

#editModal {
  display:none;
  position:fixed; top:50%; left:50%;
  transform: translate(-50%, -50%);
  background: rgba(0,0,0,0.9);
  padding:20px; border-radius:12px;
  z-index:2000; color:white;
  width:90%; max-width:400px;
}
#editModal input, #editModal textarea { width:100%; margin:5px 0; padding:8px; border-radius:6px; border:none; background: rgba(255,255,255,0.1); color:white; }
#editModal button { margin-top:10px; padding:8px 12px; border:none; border-radius:6px; cursor:pointer; background:#ff66cc; color:white; }

#closeBtn {
  position:absolute; top:10px; right:10px;
  width:30px; height:30px; border-radius:50%;
  background:#ff66cc; color:white; border:none;
  font-weight:bold; cursor:pointer; display:flex; align-items:center; justify-content:center;
  z-index:3000;
  transition: transform 0.3s;
}
#closeBtn:hover { transform: scale(1.2); }
</style>
</head>
<body>
<div class="container">
  <button id="closeBtn">×</button>
  <h1 id="profileName">Profil</h1>
  <div class="info">
    <div><strong>Pseudo :</strong> <span id="pseudo">Non renseigné</span></div>
    <div><strong>Âge :</strong> <span id="age">Non renseigné</span></div>
    <div><strong>Lieu :</strong> <span id="location">Non renseigné</span></div>
    <div><strong>Description :</strong> <span id="description">Non renseignée</span></div>
  </div>
  <img id="mainPhoto" class="main-photo" src="" alt="Photo principale">
  <div class="photos" id="photosContainer"></div>
  <button id="editBtn" class="room-btn" style="margin-top:10px;">Modifier</button>
</div>

<div class="lightbox" id="lightbox">
  <img id="lightboxImg" src="">
</div>

<div id="editModal">
  <h3>Modifier Profil</h3>
  <textarea id="editDesc" placeholder="Description"></textarea>
  <input type="text" id="editPhoto1" placeholder="URL photo principale">
  <input type="text" id="editPhoto2" placeholder="URL photo 2">
  <button id="saveEdit">Enregistrer</button>
</div>

<script type="module">
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";
import { app } from "./firebase.js";

const auth = getAuth(app);
const db = getDatabase(app);

const pseudoSpan = document.getElementById("pseudo");
const ageSpan = document.getElementById("age");
const locationSpan = document.getElementById("location");
const descSpan = document.getElementById("description");
const mainPhoto = document.getElementById("mainPhoto");
const photosContainer = document.getElementById("photosContainer");
const profileName = document.getElementById("profileName");

const lightbox = document.getElementById("lightbox");
const lightboxImg = document.getElementById("lightboxImg");

const editModal = document.getElementById("editModal");
const editBtn = document.getElementById("editBtn");
const editDesc = document.getElementById("editDesc");
const editPhoto1 = document.getElementById("editPhoto1");
const editPhoto2 = document.getElementById("editPhoto2");
const saveEdit = document.getElementById("saveEdit");

const closeBtn = document.getElementById("closeBtn");

let currentUserId;

onAuthStateChanged(auth, async user => {
  if(!user){ alert("Connectez-vous"); window.close(); return; }
  currentUserId = user.uid;

  const snap = await get(ref(db,"users/"+currentUserId));
  if(snap.exists()){
    const data = snap.val();
    pseudoSpan.textContent = data.pseudo || "Non renseigné";
    profileName.textContent = data.pseudo || "Profil";
    ageSpan.textContent = data.age || "Non renseigné";
    locationSpan.textContent = data.location || "Non renseigné";
    descSpan.textContent = data.description || "Non renseignée";

    const photos = data.photos || [];
    if(photos.length>0){
      mainPhoto.src = photos[0];
      mainPhoto.addEventListener("click",()=>{ lightboxImg.src = photos[0]; lightbox.style.display="flex"; });

      photosContainer.innerHTML="";
      photos.forEach(url=>{
        const img = document.createElement("img");
        img.src = url;
        img.addEventListener("click",()=>{ lightboxImg.src=url; lightbox.style.display="flex"; });
        photosContainer.appendChild(img);
      });
    } else { mainPhoto.src="https://via.placeholder.com/400x300?text=Photo"; }
  }
});

// Lightbox
lightbox.addEventListener("click",()=>{ lightbox.style.display="none"; lightboxImg.src=""; });

// Modifier profil
editBtn.addEventListener("click",()=>{
  editModal.style.display="block";
  editDesc.value = descSpan.textContent;
  editPhoto1.value = mainPhoto.src;
  editPhoto2.value = photosContainer.children[1] ? photosContainer.children[1].src : "";
});

saveEdit.addEventListener("click", async ()=>{
  const updates = {
    description: editDesc.value,
    photos: [editPhoto1.value]
  };
  if(editPhoto2.value) updates.photos.push(editPhoto2.value);
  await update(ref(db,"users/"+currentUserId), updates);
  descSpan.textContent = updates.description;
  mainPhoto.src = updates.photos[0];
  photosContainer.innerHTML="";
  updates.photos.forEach(url=>{
    const img = document.createElement("img");
    img.src=url;
    img.addEventListener("click",()=>{ lightboxImg.src=url; lightbox.style.display="flex"; });
    photosContainer.appendChild(img);
  });
  editModal.style.display="none";
});

// Fermer futuriste
closeBtn.addEventListener("click",()=>{
  document.querySelector(".container").style.transition="transform 0.5s, opacity 0.5s";
  document.querySelector(".container").style.transform="scale(0.1)";
  document.querySelector(".container").style.opacity="0";
  setTimeout(()=>window.close(),500);
});
</script>
</body>
</html>
