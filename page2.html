<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Mon Profil</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500&display=swap" rel="stylesheet"/>
<link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container">
    <h1>Mon Profil</h1>

    <div class="info">
      <div><strong>Pseudo :</strong> <span id="pseudo">Non renseigné</span></div>
      <div><strong>Âge :</strong> <span id="age">Non renseigné</span></div>
      <div><strong>Lieu :</strong> <span id="location">Non renseigné</span></div>
      <div><strong>Description :</strong> <span id="description">Non renseignée</span></div>
    </div>

    <img id="mainPhoto" class="main-photo" src="https://via.placeholder.com/800x360?text=Photo" alt="Photo principale">
    <div class="photos" id="photosContainer"></div>
    <div id="roomButtons" style="margin-top:12px"></div>
    <button id="logoutBtn" class="edit-btn">Déconnexion</button>
  </div>

  <div id="onlineCarouselContainer">
    <h2 style="color:#ff66cc;text-shadow:0 0 10px #ff66cc;margin-bottom:8px">Utilisateurs en ligne</h2>
    <div id="onlineCarousel"></div>
  </div>

  <div class="lightbox" id="lightbox"><img id="lightboxImg" src=""></div>

<script type="module">
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
import { getDatabase, ref, get, set, onDisconnect, onValue } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";

const firebaseConfig = {
  apiKey: "AIzaSyAbI0fvcv9lIzpPViVBx2BlO8c6L3w-rbc",
  authDomain: "affxx-copy.firebaseapp.com",
  databaseURL: "https://affxx-copy-default-rtdb.firebaseio.com",
  projectId: "affxx-copy",
  storageBucket: "affxx-copy.appspot.com",
  messagingSenderId: "763273288933",
  appId: "1:763273288933:web:d0083f5f6ab7284661c80c"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

onAuthStateChanged(auth, async user => {
  if (!user) {
    window.location.href = "inscription.html";
    return;
  }

  const uid = user.uid;
  const userStatusRef = ref(db, "users/" + uid + "/online");
  set(userStatusRef, true);
  onDisconnect(userStatusRef).set(false);

  const snap = await get(ref(db, "users/" + uid));
  if (snap.exists()) {
    const data = snap.val();
    document.getElementById("pseudo").textContent = data.pseudo || "Non renseigné";
    document.getElementById("age").textContent = data.age || "Non renseigné";
    document.getElementById("location").textContent = data.location || "Non renseigné";
    document.getElementById("description").textContent = data.description || "Non renseignée";

    const photosContainer = document.getElementById("photosContainer");
    photosContainer.innerHTML = "";
    const currentPhotos = data.photos || [];
    document.getElementById("mainPhoto").src = currentPhotos[0] || "https://via.placeholder.com/800x360?text=Photo";

    currentPhotos.forEach(url => {
      const img = document.createElement("img");
      img.src = url;
      img.addEventListener("click", () => openLightbox(url));
      photosContainer.appendChild(img);
    });

    const roomButtons = document.getElementById("roomButtons");
    roomButtons.innerHTML = "";
    (data.rooms || []).forEach(room => {
      const btn = document.createElement("button");
      btn.className = "room-btn";
      btn.textContent = room.charAt(0).toUpperCase() + room.slice(1);
      roomButtons.appendChild(btn);
    });
  }

  const usersRef = ref(db, "users");
  onValue(usersRef, snapshot => {
    const users = snapshot.val();
    const onlineCarousel = document.getElementById("onlineCarousel");
    onlineCarousel.innerHTML = "";
    if (!users) return;
    Object.keys(users).forEach(uid => {
      const u = users[uid];
      if (u.online && uid !== user.uid) {
        const card = document.createElement("div");
        card.className = "onlineCard";
        const img = document.createElement("img");
        img.src = u.photos?.[0] || "https://via.placeholder.com/100";
        const span = document.createElement("span");
        span.textContent = u.pseudo || "Utilisateur";
        card.appendChild(img);
        card.appendChild(span);
        onlineCarousel.appendChild(card);
      }
    });
  });
});

// --- Déconnexion ---
document.getElementById("logoutBtn").addEventListener("click", async () => {
  const auth = getAuth();
  await signOut(auth);
  window.location.href = "inscription.html";
});

function openLightbox(src) {
  const lightbox = document.getElementById("lightbox");
  const lightboxImg = document.getElementById("lightboxImg");
  lightboxImg.src = src;
  lightbox.style.display = "flex";
}
document.getElementById("lightbox").addEventListener("click", () => {
  document.getElementById("lightbox").style.display = "none";
});
</script>
</body>
</html>
