<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mon Profil</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500&display=swap" rel="stylesheet"/>
<style>
  body {
    margin: 0;
    font-family: 'Orbitron', sans-serif;
    background: url("planete-magique.jpg") no-repeat center center/cover;
    color: #fff;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
  }
  .container {
    background: rgba(0,0,0,0.6);
    padding: 25px;
    border-radius: 15px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 0 20px #ff66cc;
    text-align: center;
  }
  h1 {
    color: #ff66cc;
    text-shadow: 0 0 10px #ff66cc;
    margin-bottom: 20px;
  }
  .info { margin-bottom: 20px; text-align: left; }
  .info div { margin: 8px 0; }
  .photos { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin: 15px 0; }
  .photos img {
    width: 70px; height: 70px; object-fit: cover;
    border-radius: 8px; border: 2px solid #ff66cc;
    cursor: pointer; transition: transform 0.2s;
  }
  .photos img:hover { transform: scale(1.1); }
  button { margin-top: 15px; padding: 12px; width: 100%; border: none; border-radius: 8px;
    background: #ff66cc; color: white; font-size: 1em; cursor: pointer;
    box-shadow: 0 0 10px #ff66cc; transition: 0.3s; }
  button:hover { box-shadow: 0 0 20px #ff66cc; }
  .edit-section { margin-top: 20px; display: none; }
  textarea, input[type="file"] { width: 100%; margin: 10px 0; padding: 10px; border-radius: 8px; border: none; font-family: 'Orbitron'; }
  .preview { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
  .preview img { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; border: 2px solid #ff66cc; }
  .lightbox {
    display: none; position: fixed; z-index: 1000; top: 0; left: 0;
    width: 100%; height: 100%; background: rgba(0,0,0,0.9);
    justify-content: center; align-items: center;
  }
  .lightbox img { max-width: 90%; max-height: 90%; border-radius: 10px; box-shadow: 0 0 25px #ff66cc; }
  .rooms-buttons { display: flex; justify-content: space-between; margin-top: 20px; gap:10px; flex-wrap: wrap; }
  .rooms-buttons button { flex: 1; padding: 12px; font-weight: bold; text-transform: uppercase; font-size: 1em; transition: 0.3s; }
  .serieux { background: #ff4d4d; box-shadow: 0 0 10px #ff4d4d; }
  .amical { background: #4dff4d; box-shadow: 0 0 10px #4dff4d; }
  .fun { background: #4d4dff; box-shadow: 0 0 10px #4d4dff; }
  .serieux:hover { box-shadow: 0 0 20px #ff4d4d; }
  .amical:hover { box-shadow: 0 0 20px #4dff4d; }
  .fun:hover { box-shadow: 0 0 20px #4d4dff; }
</style>
</head>
<body>
<div class="container">
  <h1>Mon Profil</h1>
  <div class="info">
    <div><strong>Pseudo :</strong> <span id="pseudo"></span></div>
    <div><strong>Âge :</strong> <span id="age"></span></div>
    <div><strong>Lieu :</strong> <span id="location"></span></div>
    <div><strong>Description :</strong> <span id="description"></span></div>
    <div><strong>Salles :</strong> <span id="rooms"></span></div>
  </div>

  <div class="photos" id="photosContainer"></div>

  <button id="editBtn">Modifier</button>

  <div class="edit-section" id="editSection">
    <textarea id="newDescription" rows="3" placeholder="Nouvelle description"></textarea>
    <input type="file" id="newPhotos" accept="image/*" multiple>
    <div class="preview" id="preview"></div>
    <button id="saveBtn">Enregistrer</button>
  </div>

  <div class="rooms-buttons" id="roomsButtons"></div>
</div>

<div class="lightbox" id="lightbox">
  <img id="lightboxImg" src="" alt="Zoom photo">
</div>

<script type="module">
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";
import { app } from "./firebase.js";

const auth = getAuth(app);
const db = getDatabase(app);

const pseudoSpan = document.getElementById("pseudo");
const ageSpan = document.getElementById("age");
const locationSpan = document.getElementById("location");
const descSpan = document.getElementById("description");
const roomsSpan = document.getElementById("rooms");
const photosContainer = document.getElementById("photosContainer");

const editBtn = document.getElementById("editBtn");
const editSection = document.getElementById("editSection");
const newDesc = document.getElementById("newDescription");
const newPhotos = document.getElementById("newPhotos");
const preview = document.getElementById("preview");
const saveBtn = document.getElementById("saveBtn");

const lightbox = document.getElementById("lightbox");
const lightboxImg = document.getElementById("lightboxImg");

const roomsButtonsDiv = document.getElementById("roomsButtons");

let currentUserId = null;
let currentPhotos = [];
let currentRooms = [];

onAuthStateChanged(auth, async user => {
  if (!user) { alert("Vous devez être connecté !"); window.location.href = "inscription.html"; return; }
  currentUserId = user.uid;

  const snap = await get(ref(db, "users/" + user.uid));
  if (snap.exists()) {
    const data = snap.val();
    pseudoSpan.textContent = data.pseudo || "";
    ageSpan.textContent = data.age || "";
    locationSpan.textContent = data.location || "";
    descSpan.textContent = data.description || "";
    currentRooms = data.rooms || [];
    roomsSpan.textContent = currentRooms.join(", ");
    currentPhotos = data.photos || [];
    displayPhotos(currentPhotos);
    displayRoomsButtons(currentRooms);
  }
});

function displayPhotos(photos) {
  photosContainer.innerHTML = "";
  photos.forEach(url => {
    const img = document.createElement("img");
    img.src = url;
    img.addEventListener("click", () => { lightboxImg.src = url; lightbox.style.display = "flex"; });
    photosContainer.appendChild(img);
  });
}

lightbox.addEventListener("click", () => { lightbox.style.display = "none"; });

editBtn.addEventListener("click", () => {
  editSection.style.display = editSection.style.display === "none" ? "block" : "none";
  newDesc.value = descSpan.textContent;
});

newPhotos.addEventListener("change", () => {
  let files = Array.from(newPhotos.files);
  if (files.length > 5) files = files.slice(0, 5);
  const dt = new DataTransfer();
  files.forEach(file => dt.items.add(file));
  newPhotos.files = dt.files;

  preview.innerHTML = "";
  files.forEach(file => {
    const img = document.createElement("img");
    img.src = URL.createObjectURL(file);
    preview.appendChild(img);
  });
});

saveBtn.addEventListener("click", async () => {
  const desc = newDesc.value.trim();
  const files = Array.from(newPhotos.files);

  if (files.length > 0) {
    const promises = files.map(file => new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = e => resolve(e.target.result);
      reader.onerror = e => reject(e);
      reader.readAsDataURL(file);
    }));
    try {
      const updatedPhotos = await Promise.all(promises);
      updateProfile(desc, updatedPhotos);
    } catch (err) { console.error(err); alert("Erreur lors du chargement des photos !"); }
  } else {
    updateProfile(desc, currentPhotos);
  }
});

function updateProfile(desc, photos) {
  update(ref(db, "users/" + currentUserId), { description: desc, photos: photos })
    .then(() => {
      descSpan.textContent = desc;
      currentPhotos = photos;
      displayPhotos(currentPhotos);
      preview.innerHTML = "";
      newPhotos.value = "";
      editSection.style.display = "none";
      alert("Profil mis à jour !");
    })
    .catch(err => { console.error(err); alert("Erreur lors de la mise à jour !"); });
}

function displayRoomsButtons(rooms) {
  roomsButtonsDiv.innerHTML = "";
  rooms.forEach(room => {
    const btn = document.createElement("button");
    if(room === "serieux") { btn.textContent = "Sérieux"; btn.className = "serieux"; btn.onclick = () => window.location.href="authentique.html"; }
    if(room === "amical") { btn.textContent = "Amical"; btn.className = "amical"; btn.onclick = () => window.location.href="amicale.html"; }
    if(room === "fun") { btn.textContent = "Fun"; btn.className = "fun"; btn.onclick = () => window.location.href="fun.html"; }
    roomsButtonsDiv.appendChild(btn);
  });
}
</script>
</body>
</html>
