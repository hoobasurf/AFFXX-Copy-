<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Mon Profil</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500&display=swap" rel="stylesheet"/>
<link rel="stylesheet" href="style.css" />
<style>
  body { font-family: 'Orbitron', sans-serif; background: url('ville.jpg') no-repeat center center/cover; color: #fff; }
  .container { background: rgba(0,0,0,0.4); padding:20px; border-radius:15px; max-width:600px; margin:40px auto; box-shadow:0 0 20px #ff66cc; text-align:center; }
  .info div { margin: 8px 0; }
  .main-photo { width:100%; max-height:360px; object-fit:cover; border-radius:8px; margin:10px 0; border:2px solid #ff66cc; }
  .photos img { width:80px; height:80px; object-fit:cover; margin:5px; border-radius:8px; border:2px solid #ff66cc; cursor:pointer; transition:0.2s; }
  .photos img:hover { transform:scale(1.2); }
  .room-btn { margin:3px; padding:6px 12px; border:2px solid #ff66cc; border-radius:8px; background: rgba(0,0,0,0.4); color:#fff; cursor:default; }
  .edit-btn { margin-top:15px; padding:10px 20px; border-radius:8px; border:2px solid #ff66cc; background: rgba(0,0,0,0.4); color:#fff; cursor:pointer; }
  #onlineCarousel { display:flex; gap:10px; overflow-x:auto; margin-top:10px; }
  .onlineCard { display:flex; flex-direction:column; align-items:center; width:80px; }
  .onlineCard img { width:60px; height:60px; border-radius:50%; border:2px solid #ff66cc; }
  .lightbox { display:none; position:fixed; z-index:10000; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); justify-content:center; align-items:center; }
  .lightbox img { max-width:90%; max-height:90%; border-radius:10px; box-shadow:0 0 25px #ff66cc; }
</style>
</head>
<body>

<div class="container">
  <h1>Mon Profil</h1>
  <div class="info">
    <div><strong>Pseudo :</strong> <span id="pseudo">Non renseigné</span></div>
    <div><strong>Âge :</strong> <span id="age">Non renseigné</span></div>
    <div><strong>Lieu :</strong> <span id="location">Non renseigné</span></div>
    <div><strong>Description :</strong> <span id="description">Non renseignée</span></div>
  </div>

  <img id="mainPhoto" class="main-photo" src="https://via.placeholder.com/800x360?text=Photo" alt="Photo principale">
  <div class="photos" id="photosContainer"></div>
  <div id="roomButtons" style="margin-top:12px"></div>
  <button id="logoutBtn" class="edit-btn">Déconnexion</button>
</div>

<div id="onlineCarouselContainer">
  <h2 style="color:#ff66cc;text-shadow:0 0 10px #ff66cc;margin-bottom:8px">Utilisateurs en ligne</h2>
  <div id="onlineCarousel"></div>
</div>

<div class="lightbox" id="lightbox"><img id="lightboxImg" src=""></div>

<script type="module">
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
import { getDatabase, ref, get, onValue, onDisconnect, set } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";

const firebaseConfig = {
  apiKey: "AIzaSyAbI0fvcv9lIzpPViVBx2BlO8c6L3w-rbc",
  authDomain: "affxx-copy.firebaseapp.com",
  databaseURL: "https://affxx-copy-default-rtdb.firebaseio.com",
  projectId: "affxx-copy",
  storageBucket: "affxx-copy.appspot.com",
  messagingSenderId: "763273288933",
  appId: "1:763273288933:web:d0083f5f6ab7284661c80c"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

onAuthStateChanged(auth, async user => {
  if (!user) { window.location.href = "inscription.html"; return; }

  const uid = user.uid;

  // Online status
  const userStatusRef = ref(db, "users/" + uid + "/online");
  set(userStatusRef, true);
  onDisconnect(userStatusRef).set(false);

  // Récupération données utilisateur
  const snap = await get(ref(db, "users/" + uid));
  if (snap.exists()) {
    const data = snap.val();
    document.getElementById("pseudo").textContent = data.pseudo || "Non renseigné";
    document.getElementById("age").textContent = data.age || "Non renseigné";
    document.getElementById("location").textContent = data.location || "Non renseigné";
    document.getElementById("description").textContent = data.description || "Non renseignée";

    // Photos
    const photosContainer = document.getElementById("photosContainer");
    photosContainer.innerHTML = "";
    const currentPhotos = data.photos || [];
    document.getElementById("mainPhoto").src = currentPhotos[0] || "https://via.placeholder.com/800x360?text=Photo";
    currentPhotos.forEach(url => {
      const img = document.createElement("img");
      img.src = url;
      img.addEventListener("click", () => openLightbox(url));
      photosContainer.appendChild(img);
    });

    // Salles
    const roomButtons = document.getElementById("roomButtons");
    roomButtons.innerHTML = "";
    (data.rooms || []).forEach(room => {
      const btn = document.createElement("button");
      btn.className = "room-btn";
      btn.textContent = room.charAt(0).toUpperCase() + room.slice(1);
      roomButtons.appendChild(btn);
    });
  }

  // Utilisateurs en ligne
  const usersRef = ref(db, "users");
  onValue(usersRef, snapshot => {
    const users = snapshot.val();
    const onlineCarousel = document.getElementById("onlineCarousel");
    onlineCarousel.innerHTML = "";
    if (!users) return;
    Object.keys(users).forEach(uid => {
      const u = users[uid];
      if (u.online && uid !== user.uid) {
        const card = document.createElement("div");
        card.className = "onlineCard";
        const img = document.createElement("img");
        img.src = u.photos?.[0] || "https://via.placeholder.com/100";
        const span = document.createElement("span");
        span.textContent = u.pseudo || "Utilisateur";
        card.appendChild(img);
        card.appendChild(span);
        onlineCarousel.appendChild(card);
      }
    });
  });
});

// Déconnexion
document.getElementById("logoutBtn").addEventListener("click", async () => {
  await signOut(auth);
  window.location.href = "inscription.html";
});

// Lightbox
function openLightbox(src) {
  const lightbox = document.getElementById("lightbox");
  const lightboxImg = document.getElementById("lightboxImg");
  lightboxImg.src = src;
  lightbox.style.display = "flex";
}
document.getElementById("lightbox").addEventListener("click", () => {
  document.getElementById("lightbox").style.display = "none";
});
</script>

</body>
</html>
