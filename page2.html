<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Mon Profil</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500&display=swap" rel="stylesheet"/>
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%;width:100%;font-family:'Orbitron',sans-serif;background:url('ville.jpg') no-repeat center center/cover;background-attachment:fixed;color:#fff;overflow-y:auto}
  .container{max-width:600px;margin:30px auto;background:rgba(0,0,0,0.6);padding:24px;border-radius:15px;box-shadow:0 0 20px #ff66cc;text-align:center}
  h1{color:#ff66cc;text-shadow:0 0 10px #ff66cc;margin-bottom:12px}
  .info{margin-bottom:12px;text-align:left}
  .info div{margin:8px 0}
  .main-photo{width:100%;max-height:360px;object-fit:cover;border-radius:10px;border:2px solid #ff66cc;cursor:pointer}
  .photos{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:12px}
  .photos img{width:70px;height:70px;object-fit:cover;border-radius:8px;border:2px solid #ff66cc;cursor:pointer;transition:transform .15s}
  .photos img:hover{transform:scale(1.15)}
  .room-btn{padding:10px 20px;margin:8px;border:2px solid #ff66cc;background:rgba(0,0,0,0.4);color:#fff;border-radius:8px;cursor:pointer;box-shadow:0 0 10px #ff66cc,0 0 20px #ff66cc inset}
  .edit-btn{margin-top:10px;padding:8px 14px;border-radius:8px;border:2px solid #ff66cc;background:rgba(0,0,0,0.4);color:#fff;cursor:pointer}
  .lightbox{display:none;position:fixed;z-index:10000;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.92);display:flex;align-items:center;justify-content:center}
  .lightbox img{max-width:92%;max-height:92%;border-radius:10px;box-shadow:0 0 25px #ff66cc}
  /* modal éditer */
  .modal{display:none;position:fixed;z-index:12000;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.75);align-items:center;justify-content:center}
  .modal .box{background:rgba(0,0,0,0.6);padding:18px;border-radius:12px;width:90%;max-width:480px;box-shadow:0 0 20px #ff66cc}
  .modal input, .modal textarea{width:100%;margin:8px 0;padding:8px;border-radius:8px;border:2px solid #ff66cc;background:rgba(0,0,0,0.4);color:#fff}
  .modal .row{display:flex;gap:8px}
  .modal button{flex:1;padding:10px;border-radius:8px;border:2px solid #ff66cc;background:rgba(0,0,0,0.4);color:#fff;cursor:pointer}
</style>
</head>
<body>
  <div class="container">
    <h1>Mon Profil</h1>

    <div class="info">
      <div><strong>Pseudo :</strong> <span id="pseudo">Non renseigné</span></div>
      <div><strong>Âge :</strong> <span id="age">Non renseigné</span></div>
      <div><strong>Lieu :</strong> <span id="location">Non renseigné</span></div>
      <div><strong>Description :</strong> <span id="description">Non renseignée</span></div>
    </div>

    <img id="mainPhoto" class="main-photo" src="https://via.placeholder.com/800x360?text=Photo" alt="Photo principale">

    <div class="photos" id="photosContainer"></div>

    <div id="roomButtons" style="margin-top:12px"></div>

    <button id="editBtn" class="edit-btn">Modifier</button>
  </div>

  <div class="lightbox" id="lightbox"><img id="lightboxImg" src=""></div>

  <!-- Modal Modifier -->
  <div class="modal" id="modalEdit">
    <div class="box">
      <h3 style="color:#ff66cc;margin-bottom:8px">Modifier description / photos</h3>
      <textarea id="editDescription" rows="3" placeholder="Nouvelle description..."></textarea>
      <input type="file" id="editPhotos" accept="image/*" multiple>
      <div class="photos" id="editPreview"></div>
      <div class="row" style="margin-top:10px">
        <button id="saveEdit">Enregistrer</button>
        <button id="cancelEdit">Annuler</button>
      </div>
    </div>
  </div>

<script type="module">
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
  import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";
  import { app } from "./firebase.js";

  const auth = getAuth(app);
  const db = getDatabase(app);

  const pseudoSpan = document.getElementById('pseudo');
  const ageSpan = document.getElementById('age');
  const locationSpan = document.getElementById('location');
  const descSpan = document.getElementById('description');
  const mainPhoto = document.getElementById('mainPhoto');
  const photosContainer = document.getElementById('photosContainer');
  const roomButtons = document.getElementById('roomButtons');

  const lightbox = document.getElementById('lightbox');
  const lightboxImg = document.getElementById('lightboxImg');

  const modalEdit = document.getElementById('modalEdit');
  const editDescription = document.getElementById('editDescription');
  const editPhotos = document.getElementById('editPhotos');
  const editPreview = document.getElementById('editPreview');
  const saveEdit = document.getElementById('saveEdit');
  const cancelEdit = document.getElementById('cancelEdit');
  const editBtn = document.getElementById('editBtn');

  let currentUid = null;
  let currentPhotos = [];

  onAuthStateChanged(auth, async user => {
    if(!user){
      alert('Vous devez être connecté !');
      window.location.href = 'inscription.html';
      return;
    }
    currentUid = user.uid;
    const snap = await get(ref(db, 'users/' + user.uid));
    if(snap.exists()){
      const data = snap.val();
      pseudoSpan.textContent = data.pseudo || 'Non renseigné';
      ageSpan.textContent = data.age || 'Non renseigné';
      locationSpan.textContent = data.location || 'Non renseigné';
      descSpan.textContent = data.description || 'Non renseignée';

      currentPhotos = data.photos || [];
      if(currentPhotos.length>0){
        mainPhoto.src = currentPhotos[0];
      } else {
        mainPhoto.src = 'https://via.placeholder.com/800x360?text=Photo';
      }

      // thumbnails
      photosContainer.innerHTML = '';
      (currentPhotos||[]).forEach(url=>{
        const img = document.createElement('img');
        img.src = url;
        img.addEventListener('click', ()=> { openLightbox(url); });
        photosContainer.appendChild(img);
      });

      // room buttons (functional)
      roomButtons.innerHTML = '';
      (data.rooms||[]).forEach(room=>{
        const btn = document.createElement('button');
        btn.className = 'room-btn';
        btn.textContent = room.charAt(0).toUpperCase()+room.slice(1);
        btn.addEventListener('click', ()=>{
          let page = '';
          if(room === 'serieux') page = 'authentique.html';
          if(room === 'amicale') page = 'amicale.html';
          if(room === 'fun') page = 'fun.html';
          // redirection -> assumes files at root
          window.location.href = page;
        });
        roomButtons.appendChild(btn);
      });
    }
  });

  function openLightbox(src){ lightboxImg.src = src; lightbox.style.display = 'flex'; }
  lightbox.addEventListener('click', ()=>{ lightbox.style.display = 'none'; lightboxImg.src = ''; });

  // EDIT modal open
  editBtn.addEventListener('click', async ()=> {
    // preload current description and photos
    const snap = await get(ref(db, 'users/' + currentUid));
    if(snap.exists()){
      const data = snap.val();
      editDescription.value = data.description || '';
      editPreview.innerHTML = '';
      (data.photos || []).forEach(url=>{
        const img = document.createElement('img');
        img.src = url;
        img.style.width='60px'; img.style.height='60px';
        img.style.objectFit='cover'; img.style.borderRadius='6px'; img.style.border='2px solid #ff66cc';
        editPreview.appendChild(img);
      });
    }
    modalEdit.style.display = 'flex';
  });

  // preview selected files in modal
  let stagedEditFiles = [];
  editPhotos.addEventListener('change', e=>{
    const files = Array.from(e.target.files||[]).slice(0,5);
    stagedEditFiles = files;
    editPreview.innerHTML = '';
    files.forEach(file=>{
      const r = new FileReader();
      r.onload = ev => {
        const img = document.createElement('img');
        img.src = ev.target.result;
        img.style.width='60px'; img.style.height='60px'; img.style.objectFit='cover'; img.style.borderRadius='6px'; img.style.border='2px solid #ff66cc';
        editPreview.appendChild(img);
      };
      r.readAsDataURL(file);
    });
  });

  cancelEdit.addEventListener('click', ()=>{ modalEdit.style.display = 'none'; stagedEditFiles = []; editPhotos.value = ''; editPreview.innerHTML=''; });

  // save edited description/photos
  saveEdit.addEventListener('click', async ()=>{
    const newDesc = editDescription.value.trim();
    // convert stagedEditFiles to DataURL if any, else keep currentPhotos
    function filesToDataURLs(files){
      return Promise.all((files||[]).slice(0,5).map(f=>new Promise((res,rej)=>{
        const fr = new FileReader();
        fr.onload = e => res(e.target.result);
        fr.onerror = rej;
        fr.readAsDataURL(f);
      })));
    }
    try{
      let photosToSave = currentPhotos;
      if(stagedEditFiles && stagedEditFiles.length>0){
        photosToSave = await filesToDataURLs(stagedEditFiles);
      }
      await update(ref(db, 'users/' + currentUid), { description: newDesc, photos: photosToSave });
      // update UI
      descSpan.textContent = newDesc || 'Non renseignée';
      currentPhotos = photosToSave;
      if(currentPhotos.length>0) mainPhoto.src = currentPhotos[0];
      photosContainer.innerHTML = '';
      (currentPhotos||[]).forEach(url=>{
        const img = document.createElement('img');
        img.src = url;
        img.addEventListener('click', ()=> openLightbox(url));
        photosContainer.appendChild(img);
      });
      // close modal
      modalEdit.style.display = 'none';
      stagedEditFiles = [];
      editPhotos.value = '';
      editPreview.innerHTML = '';
      alert('Profil mis à jour !');
    }catch(e){
      alert(e.message || e);
    }
  });

</script>
</body>
</html>
