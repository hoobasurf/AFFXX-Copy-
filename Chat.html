<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat Priv√©</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500&display=swap" rel="stylesheet">
  <style>
    body {
      margin:0;
      padding:0;
      height:100vh;
      width:100vw;
      font-family:'Orbitron', sans-serif;
      display:flex;
      flex-direction:column;
      background: url('/ville.jpg') no-repeat center center/cover;
      background-size: cover;
    }
    #chatContainer {
      flex:1;
      display:flex;
      flex-direction:column;
      padding: 20px;
      overflow-y:auto;
      backdrop-filter: blur(3px);
      background: rgba(0,0,0,0.3);
      margin: 20px;
      border-radius:15px;
      border:2px solid rgba(0,0,0,0.5);
    }
    #messages {
      flex:1;
      overflow-y:auto;
    }
    .message {
      margin: 5px 0;
      padding: 8px 12px;
      border-radius:10px;
      max-width: 80%;
      word-wrap: break-word;
    }
    .me {
      background: #ff6aab;
      color:white;
      align-self:flex-end;
      box-shadow: 0 0 5px #ff6aab, 0 0 15px #d600d6;
    }
    .other {
      background: rgba(255,255,255,0.2);
      color:white;
      align-self:flex-start;
    }
    #inputContainer {
      display:flex;
      margin:20px;
    }
    #msgInput {
      flex:1;
      padding:12px;
      border-radius:8px;
      border:none;
      outline:none;
      font-size:16px;
    }
    #sendBtn {
      padding:12px 20px;
      margin-left:10px;
      border:none;
      border-radius:8px;
      background:#ff6aab;
      color:white;
      font-size:16px;
      cursor:pointer;
      box-shadow: 0 0 5px #ff6aab, 0 0 15px #d600d6;
    }
  </style>
</head>
<body>

<div id="chatContainer">
  <div id="messages"></div>
</div>

<div id="inputContainer">
  <input type="text" id="msgInput" placeholder="√âcrire un message...">
  <button id="sendBtn">Envoyer</button>
</div>

<script type="module">
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
  import { getDatabase, ref, push, onChildAdded } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";
  import { app } from "./firebase.js";

  const auth = getAuth(app);
  const db = getDatabase(app);

  const messagesDiv = document.getElementById('messages');
  const msgInput = document.getElementById('msgInput');
  const sendBtn = document.getElementById('sendBtn');

  let currentUser = null;
  let chatId = null; // chat unique entre 2 utilisateurs

  // üîπ V√©rifie si utilisateur connect√©
  onAuthStateChanged(auth, (user) => {
    if (!user) {
      window.location.href = "inscription.html"; // redirige si pas connect√©
    } else {
      currentUser = user;
      // üîπ Ici, tu peux g√©n√©rer le chatId dynamique selon les deux utilisateurs
      // Exemple simple pour test : chat entre user.uid et un uid fixe "otherUserUid"
      const otherUserUid = prompt("UID de l'autre utilisateur pour ce chat :");
      chatId = [currentUser.uid, otherUserUid].sort().join("_"); // ordre fixe pour unique chatId
      initChat();
    }
  });

  function initChat() {
    const chatRef = ref(db, 'chats/' + chatId + '/messages');

    // √âcoute les messages en temps r√©el
    onChildAdded(chatRef, (snapshot) => {
      const msg = snapshot.val();
      const div = document.createElement('div');
      div.classList.add('message');
      div.classList.add(msg.sender === currentUser.uid ? 'me' : 'other');
      div.textContent = msg.text;
      messagesDiv.appendChild(div);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });

    // Envoyer message
    sendBtn.addEventListener('click', () => {
      const text = msgInput.value.trim();
      if (!text) return;
      push(chatRef, {
        text,
        sender: currentUser.uid,
        timestamp: Date.now()
      });
      msgInput.value = '';
    });

    // Envoi avec touche Enter
    msgInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendBtn.click();
    });
  }
</script>

</body>
</html>
