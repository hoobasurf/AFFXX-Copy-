<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Affinix profils + chat + favoris + sidebar mini profils</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 20px;
    background: #fafafa;
  }
  .cards-container {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
  }
  .card {
    position: relative;
    border: 1px solid #ddd;
    border-radius: 10px;
    width: 180px;
    padding: 10px;
    background: white;
    box-shadow: 0 0 5px #ccc;
  }
  .card img {
    width: 100%;
    border-radius: 10px;
    height: 120px;
    object-fit: cover;
  }
  .card h3 {
    margin: 8px 0 4px 0;
    font-size: 18px;
  }
  .card p {
    font-size: 14px;
    color: #555;
  }
  /* Boutons */
  .btn-fav, .btn-chat {
    position: absolute;
    top: 10px;
    font-size: 24px;
    cursor: pointer;
    user-select: none;
    transition: color 0.3s ease;
  }
  .btn-fav {
    right: 40px;
    color: #aaa;
  }
  .btn-fav.fav-active {
    color: gold;
    text-shadow: 0 0 5px gold;
  }
  .btn-chat {
    right: 10px;
    color: #555;
  }
  .btn-chat:hover {
    color: #000;
  }

  /* Sidebar mini profils */
  .sidebar {
    position: fixed;
    top: 10px;
    left: 10px;
    width: 100px;
    min-height: 100px;
    background: rgba(255 255 255 / 0.9);
    border: 1px solid #ccc;
    border-radius: 10px;
    padding: 8px 5px;
    box-sizing: border-box;
    z-index: 9999;
  }
  .mini-profile {
    position: absolute;
    width: 80px;
    height: 80px;
    border: 1px solid #ccc;
    border-radius: 10px;
    background: white;
    cursor: move;
    padding: 5px;
    box-sizing: border-box;
    text-align: center;
    user-select: none;
    box-shadow: 0 0 6px rgba(0,0,0,0.1);
  }
  .mini-profile img {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    object-fit: cover;
  }
  .mini-profile div {
    font-size: 12px;
    margin-top: 4px;
  }

  /* Chat Modal */
  #chatModal {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 320px;
    max-width: 90vw;
    background: white;
    border-radius: 10px;
    box-shadow: 0 0 15px #888;
    z-index: 10000;
    flex-direction: column;
  }
  #chatModal.active {
    display: flex;
  }
  #chatModal header {
    background: #007bff;
    color: white;
    padding: 10px;
    border-radius: 10px 10px 0 0;
    font-weight: bold;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  #chatModal header button {
    background: none;
    border: none;
    color: white;
    font-size: 20px;
    cursor: pointer;
  }
  #chatBody {
    padding: 10px;
    flex: 1;
    display: flex;
    flex-direction: column;
  }
  #chatTextarea {
    flex: 1;
    resize: none;
    width: 100%;
    font-size: 14px;
    padding: 8px;
    border-radius: 6px;
    border: 1px solid #ccc;
    box-sizing: border-box;
    margin-bottom: 8px;
    font-family: monospace;
    height: 150px;
    overflow-y: auto;
  }
  #sendChatBtn {
    background: #007bff;
    color: white;
    border: none;
    padding: 8px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
  }
</style>
</head>
<body>

<h1>Profils Affinix avec Favoris, Chat & Sidebar Mini-Profils</h1>

<div class="cards-container">
  <div class="card" data-name="Clara, 28 ans, sportive, artiste">
    <img src="https://i.pravatar.cc/150?img=3" alt="Clara" />
    <h3>Clara</h3>
    <p>28 ans, sportive, artiste</p>
    <div class="btn-fav" title="Ajouter aux favoris" role="button" aria-label="Ajouter aux favoris">&#9734;</div>
    <div class="btn-chat" title="Ouvrir chat" role="button" aria-label="Ouvrir chat">&#9993;</div>
  </div>
  <div class="card" data-name="Maxime, 31 ans, passionné de musique">
    <img src="https://i.pravatar.cc/150?img=5" alt="Maxime" />
    <h3>Maxime</h3>
    <p>31 ans, passionné de musique</p>
    <div class="btn-fav" title="Ajouter aux favoris" role="button" aria-label="Ajouter aux favoris">&#9734;</div>
    <div class="btn-chat" title="Ouvrir chat" role="button" aria-label="Ouvrir chat">&#9993;</div>
  </div>
  <div class="card" data-name="Sophie, 26 ans, amatrice de lecture">
    <img src="https://i.pravatar.cc/150?img=7" alt="Sophie" />
    <h3>Sophie</h3>
    <p>26 ans, amatrice de lecture</p>
    <div class="btn-fav" title="Ajouter aux favoris" role="button" aria-label="Ajouter aux favoris">&#9734;</div>
    <div class="btn-chat" title="Ouvrir chat" role="button" aria-label="Ouvrir chat">&#9993;</div>
  </div>
</div>

<div class="sidebar"></div>

<!-- Chat Modal -->
<div id="chatModal" role="dialog" aria-modal="true" aria-labelledby="chatWith">
  <header>
    <span id="chatWith">Chat avec ...</span>
    <button id="closeChatModal" aria-label="Fermer chat">&times;</button>
  </header>
  <div id="chatBody">
    <textarea id="chatTextarea" placeholder="Écris ton message ici..."></textarea>
    <button id="sendChatBtn">Envoyer</button>
  </div>
</div>

<script>
  // 1. Favoris (étoile vide/pleine jaune) + stockage local
  document.querySelectorAll('.btn-fav').forEach(btn => {
    const card = btn.closest('.card');
    const profName = card.dataset.name;

    // Charger état favori
    const favs = JSON.parse(localStorage.getItem('affinix-favs') || '{}');
    if (favs[profName]) btn.classList.add('fav-active');

    btn.addEventListener('click', e => {
      e.stopPropagation(); // éviter ouverture modal profil au clic sur étoile
      if (btn.classList.contains('fav-active')) {
        btn.classList.remove('fav-active');
        delete favs[profName];
      } else {
        btn.classList.add('fav-active');
        favs[profName] = true;
      }
      localStorage.setItem('affinix-favs', JSON.stringify(favs));
    });
  });

  // 2. Chat modal gestion + historique par profil (localStorage)
  const chatModal = document.getElementById('chatModal');
  const chatWith = document.getElementById('chatWith');
  const chatTextarea = document.getElementById('chatTextarea');
  const sendChatBtn = document.getElementById('sendChatBtn');

  let currentChatProf = null;

  document.querySelectorAll('.btn-chat').forEach(btn => {
    btn.addEventListener('click', e => {
      e.stopPropagation();
      const card = btn.closest('.card');
      currentChatProf = card.dataset.name;
      chatWith.textContent = `Chat avec ${currentChatProf}`;

      // Charger historique
      const history = JSON.parse(localStorage.getItem('affinix-chat-' + currentChatProf) || '[]');
      chatTextarea.value = history.join('\n') + (history.length ? '\n' : '');
      chatModal.classList.add('active');

      // Ajouter mini profil si pas déjà affiché
      addMiniProfile(card);
    });
  });

  document.getElementById('closeChatModal').addEventListener('click', () => {
    chatModal.classList.remove('active');
  });

  // Envoyer message
  sendChatBtn.addEventListener('click', () => {
    if (!currentChatProf) return;
    const msg = chatTextarea.value.trim();
    if (!msg) return;

    let history = JSON.parse(localStorage.getItem('affinix-chat-' + currentChatProf) || '[]');
    history.push(msg);
    localStorage.setItem('affinix-chat-' + currentChatProf, JSON.stringify(history));

    alert('Message enregistré localement.');
  });

  // 3 + 4 + 5 Sidebar mini profils avec drag & drop + stockage position + pas de suppression auto
  const sidebar = document.querySelector('.sidebar');

  function addMiniProfile(card) {
    const profName = card.dataset.name;
    if (document.querySelector(`.sidebar .mini-profile[data-name="${profName}"]`)) return; // déjà ajouté

    const mini = document.createElement('div');
    mini.className = 'mini-profile';
    mini.dataset.name = profName;
    mini.style.position = 'absolute';
    mini.style.width = '80px';
    mini.style.height = '80px';
    mini.style.border = '1px solid #ccc';
    mini.style.borderRadius = '10px';
    mini.style.background = 'white';
    mini.style.cursor = 'move';
    mini.style.padding = '5px';
    mini.style.boxSizing = 'border-box';
    mini.style.textAlign = 'center';
    mini.style.userSelect = 'none';

    const img = card.querySelector('img').cloneNode();
    img.style.width = '50px';
    img.style.height = '50px';
    img.style.borderRadius = '50%';
    img.style.objectFit = 'cover';
    mini.appendChild(img);

    const shortName = profName.split(',')[0].slice(0, 3);
    const nameSpan = document.createElement('div');
    nameSpan.textContent = shortName;
    nameSpan.style.fontSize = '12px';
    mini.appendChild(nameSpan);

    // Charger position depuis localStorage
    const pos = JSON.parse(localStorage.getItem('affinix-mini-pos') || '{}');
    if (pos[profName]) {
      mini.style.left = pos[profName].x + 'px';
      mini.style.top = pos[profName].y + 'px';
    } else {
      mini.style.left = '10px';
      mini.style.top = (10 + 90 * sidebar.children.length) + 'px';
    }

    // Drag & Drop
    let offsetX, offsetY, dragging = false;

    mini.addEventListener('mousedown', e => {
      dragging = true;
      offsetX = e.clientX - mini.offsetLeft;
      offsetY = e.clientY - mini.offsetTop;
      mini.style.transition = 'none';
      e.preventDefault();
    });

    document.addEventListener('mouseup', () => {
      if (dragging) {
        dragging = false;
        mini.style.transition = '';
        // Sauvegarder position
        const pos = JSON.parse(localStorage.getItem('affinix-mini-pos') || '{}');
        pos[profName] = { x: mini.offsetLeft, y: mini.offsetTop };
        localStorage.setItem('affinix-mini-pos', JSON.stringify(pos));
      }
    });

    document.addEventListener('mousemove', e => {
      if (dragging) {
        let x = e.clientX - offsetX;
        let y = e.clientY - offsetY;
        // Limiter dans sidebar (largeur sidebar = 100px)
        x = Math.min(Math.max(x, 0), window.innerWidth - mini.offsetWidth);
        y = Math.min(Math.max(y, 0), window.innerHeight - mini.offsetHeight);
        mini.style.left = x + 'px';
        mini.style.top = y + 'px';
      }
    });

    sidebar.appendChild(mini);
  }
</script>

</body>
</html>
