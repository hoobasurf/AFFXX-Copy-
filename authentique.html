<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ta page avec mini-profil + chat</title>
<style>
  /* Ta structure visuelle reste intacte, ici juste styles basiques pour mini-profil et chat */
  #left-col {
    width: 200px;
    border-right: 1px solid #ccc;
    padding: 10px;
    float: left;
    height: 100vh;
    overflow-y: auto;
  }
  #main-col {
    margin-left: 210px;
    padding: 10px;
  }
  .mini-profile {
    background: #eee;
    margin-bottom: 8px;
    padding: 5px;
    cursor: pointer;
    user-select: none;
  }
  .mini-profile.dragging {
    opacity: 0.5;
  }
  #chat-window {
    border: 1px solid #ccc;
    padding: 5px;
    margin-top: 10px;
    display: none;
    flex-direction: column;
    height: 200px;
  }
  #chat-messages {
    flex-grow: 1;
    overflow-y: auto;
    border-bottom: 1px solid #ccc;
    padding: 5px;
    max-height: 130px;
  }
  #chat-input {
    display: flex;
    margin-top: 5px;
  }
  #chat-input textarea {
    flex-grow: 1;
    resize: none;
  }
  #chat-input button {
    margin-left: 5px;
  }
</style>
</head>
<body>

<div id="left-col">
  <!-- Colonne gauche où seront ajoutés les mini-profiles -->
</div>

<div id="main-col">
  <!-- Contenu principal, ta structure visuelle doit rester ici intacte -->
  <button id="btn-message">Message</button>

  <!-- Fenêtre chat (initialement cachée) -->
  <div id="chat-window" style="display: flex; flex-direction: column;">
    <div id="chat-messages"></div>
    <div id="chat-input">
      <textarea id="chat-text" rows="2" placeholder="Tape ton message..."></textarea>
      <button id="chat-send">Envoyer</button>
    </div>
  </div>

  <!-- Ici ton contenu original conservé, tu peux ajouter à partir d'ici -->
  <p>Contenu de ta page...</p>
</div>

<script>
(() => {
  const btnMessage = document.getElementById('btn-message');
  const leftCol = document.getElementById('left-col');
  const chatWindow = document.getElementById('chat-window');
  const chatMessages = document.getElementById('chat-messages');
  const chatText = document.getElementById('chat-text');
  const chatSend = document.getElementById('chat-send');

  let currentMiniProfile = null;
  let miniProfiles = [];

  // Crée une miniature profil
  function createMiniProfile(id) {
    const div = document.createElement('div');
    div.classList.add('mini-profile');
    div.textContent = `Profil ${id}`;
    div.dataset.id = id;
    div.setAttribute('draggable', 'true');
    return div;
  }

  // Ajoute un mini-profil s’il n’existe pas
  function addMiniProfile() {
    const id = 'profil1'; // ici identifiant fixe car un seul mini-profil demandé
    if (miniProfiles.find(p => p.dataset.id === id)) return; // déjà présent

    const miniProfile = createMiniProfile(id);
    leftCol.appendChild(miniProfile);
    miniProfiles.push(miniProfile);

    attachMiniProfileEvents(miniProfile);
  }

  // Ouvre le chat sous la colonne gauche, affiche messages du profil sélectionné
  function openChatForProfile(miniProfile) {
    currentMiniProfile = miniProfile;
    chatWindow.style.display = 'flex';
    chatMessages.innerHTML = ''; // vide la conversation au départ

    // Optionnel : charger conversation précédente ici (non implémenté)

    chatText.focus();
  }

  // Ajoute un message dans la conversation affichée
  function addMessageToChat(text, fromUser = true) {
    if (!text.trim()) return;
    const msg = document.createElement('div');
    msg.textContent = (fromUser ? 'Moi: ' : 'Autre: ') + text;
    msg.style.padding = '2px 5px';
    msg.style.margin = '2px 0';
    msg.style.background = fromUser ? '#cce5ff' : '#eee';
    msg.style.borderRadius = '4px';
    chatMessages.appendChild(msg);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  // Supprime la miniature au maintien 3s
  function attachRemoveOnHold(miniProfile) {
    let holdTimer = null;
    miniProfile.addEventListener('mousedown', () => {
      holdTimer = setTimeout(() => {
        // Supprimer miniature
        leftCol.removeChild(miniProfile);
        miniProfiles = miniProfiles.filter(p => p !== miniProfile);
        // Si chat ouvert pour ce profil, fermer chat
        if (currentMiniProfile === miniProfile) {
          chatWindow.style.display = 'none';
          currentMiniProfile = null;
        }
      }, 3000);
    });
    miniProfile.addEventListener('mouseup', () => {
      if (holdTimer) clearTimeout(holdTimer);
    });
    miniProfile.addEventListener('mouseleave', () => {
      if (holdTimer) clearTimeout(holdTimer);
    });
  }

  // Drag & drop pour réorganiser les miniatures
  function enableDragDrop(miniProfile) {
    miniProfile.addEventListener('dragstart', (e) => {
      e.dataTransfer.setData('text/plain', miniProfile.dataset.id);
      miniProfile.classList.add('dragging');
    });
    miniProfile.addEventListener('dragend', () => {
      miniProfile.classList.remove('dragging');
    });
  }

  leftCol.addEventListener('dragover', (e) => {
    e.preventDefault();
    const dragging = document.querySelector('.dragging');
    if (!dragging) return;
    const afterElement = getDragAfterElement(leftCol, e.clientY);
    if (afterElement == null) {
      leftCol.appendChild(dragging);
    } else {
      leftCol.insertBefore(dragging, afterElement);
    }
  });

  function getDragAfterElement(container, y) {
    const draggableElements = [...container.querySelectorAll('.mini-profile:not(.dragging)')];

    return draggableElements.reduce((closest, child) => {
      const box = child.getBoundingClientRect();
      const offset = y - box.top - box.height / 2;
      if (offset < 0 && offset > closest.offset) {
        return { offset: offset, element: child };
      } else {
        return closest;
      }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
  }

  // Événements sur mini-profil
  function attachMiniProfileEvents(miniProfile) {
    miniProfile.addEventListener('click', () => {
      if (currentMiniProfile === miniProfile && chatWindow.style.display === 'flex') {
        // Clic sur profil déjà ouvert : toggle fermeture chat
        chatWindow.style.display = 'none';
        currentMiniProfile = null;
      } else {
        openChatForProfile(miniProfile);
      }
    });
    attachRemoveOnHold(miniProfile);
    enableDragDrop(miniProfile);
  }

  btnMessage.addEventListener('click', () => {
    addMiniProfile();
  });

  chatSend.addEventListener('click', () => {
    const text = chatText.value;
    if (!text.trim()) return;
    addMessageToChat(text, true);
    chatText.value = '';
  });

  chatText.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      chatSend.click();
    }
  });
})();
</script>

</body>
</html>
