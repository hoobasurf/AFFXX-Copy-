<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>Authentique</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500&display=swap" rel="stylesheet">
<style>
* { box-sizing:border-box; margin:0; padding:0; }
html, body { height:100%; width:100%; font-family:'Orbitron',sans-serif; background:url('planete-romantique.jpg') no-repeat center center/cover; color:white; overflow:hidden; }
body::before { content:""; position:fixed; top:0; left:0; width:100%; height:100%; background: radial-gradient(circle at center, rgba(255,0,255,0.05), transparent 70%); z-index:1; pointer-events:none; }
.header { position: relative; z-index:2; padding:20px; }
#myProfile { z-index:3; position: relative; text-align:center; margin-top:10px; cursor:pointer; }
#myProfile img { width:100px; height:100px; border-radius:50%; border:3px solid #ff66cc; box-shadow:0 0 15px #ff66cc; object-fit:cover; }
#myProfile div { margin-top:8px; font-size:1.2em; color:#ff66cc; }
/* Carrousel */
.carousel-container { z-index:2; position: relative; width:100%; height:calc(100% - 180px); overflow:hidden; display:flex; align-items:center; }
.carousel { display:flex; overflow-x:auto; scroll-snap-type:x mandatory; -webkit-overflow-scrolling:touch; gap:40px; padding:40px; }
.carousel::-webkit-scrollbar { display:none; }
.card { scroll-snap-align:center; flex:0 0 150px; background:rgba(0,0,0,0.5); border-radius:16px; padding:15px; text-align:center; transition: transform .3s, box-shadow .3s; cursor:pointer; position:relative; }
.card img { width:90px; height:90px; border-radius:50%; object-fit:cover; margin-bottom:10px; border:3px solid; }
.girl img { border-color:#ff66cc; box-shadow:0 0 12px #ff66cc; }
.boy img { border-color:#9933ff; box-shadow:0 0 12px #9933ff; }
.name { font-size:1.1em; margin-bottom:5px; }
.btns { display:flex; justify-content:center; gap:8px; margin-top:6px; }
.btn-like, .btn-chat, .btn-fav { width:30px; height:30px; border-radius:50%; background-color:rgba(255,255,255,0.1); border:1px solid #ff66cc; color:#ff66cc; display:flex; align-items:center; justify-content:center; font-size:1em; cursor:pointer; transition: transform .2s, background-color .3s, color .3s; user-select:none; }
.btn-like:hover, .btn-chat:hover, .btn-fav:hover { transform: scale(1.2); }
.btn-like.active { background-color:#ff66cc; border-color:#ff66cc; color:white; box-shadow:0 0 12px #ff66cc; }
.btn-fav.active { background-color:#ffea00; border-color:#ffea00; color:#333; box-shadow:0 0 12px #ffea00; }
</style>
</head>
<body>

<!-- MINI-PROFIL -->
<div id="myProfile">
  <img id="miniProfilePic" src="" alt="Mon profil">
  <div id="pseudoMini">Utilisateur</div>
</div>

<!-- Carrousel -->
<div class="carousel-container">
  <div class="carousel" id="carousel"></div>
</div>

<script type="module">
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
import { getDatabase, ref, update, onDisconnect, onValue } 
  from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";
import { app } from "./firebase.js";

const auth = getAuth(app);
const db = getDatabase(app);

const miniProfilePic = document.getElementById("miniProfilePic");
const pseudoMini = document.getElementById("pseudoMini");
const carousel = document.getElementById("carousel");

onAuthStateChanged(auth, async user => {
  if (!user) {
    alert("Vous devez √™tre connect√© !");
    window.location.href = "inscription.html";
    return;
  }

  const userRef = ref(db, "users/" + user.uid);

  // ‚úÖ Marquer comme connect√© d√®s que la page s'ouvre
  await update(userRef, { online: true });
  // ‚úÖ Automatiquement offline si l‚Äôutilisateur quitte
  onDisconnect(ref(db, "users/" + user.uid + "/online")).set(false);

  // ‚úÖ Affichage du mini-profil
  onValue(userRef, snap => {
    if (snap.exists()) {
      const data = snap.val();
      pseudoMini.textContent = data.pseudo || "Utilisateur";
      miniProfilePic.src = (data.photos && data.photos.length > 0)
        ? data.photos[0]
        : "https://i.pravatar.cc/150?img=12";
    }
  });

  // ‚úÖ Carrousel des utilisateurs connect√©s
  const allUsersRef = ref(db, "users");
  onValue(allUsersRef, snap => {
    carousel.innerHTML = "";
    if (!snap.exists()) return;
    const allUsers = snap.val();

    Object.entries(allUsers).forEach(([uid, u]) => {
      // Affiche seulement les autres utilisateurs en ligne
      if (uid !== user.uid && u.online === true) {
        const card = document.createElement("div");
        card.className = "card " + (u.gender || "girl");
        card.dataset.uid = uid;
        card.innerHTML = `
          <img src="${u.photos && u.photos.length > 0 ? u.photos[0] : 'https://i.pravatar.cc/150?img=12'}" alt="${u.pseudo}">
          <div class="name">${u.pseudo || 'Utilisateur'}</div>
          <div class="btns">
            <div class="btn-chat" title="Chat">üí¨</div>
            <div class="btn-like" title="Like">üíñ</div>
            <div class="btn-fav" title="Favoris">‚≠êÔ∏è</div>
          </div>
        `;
        carousel.appendChild(card);
      }
    });

    // Si aucun utilisateur connect√©
    if (carousel.innerHTML.trim() === "") {
      const emptyMsg = document.createElement("div");
      emptyMsg.style.textAlign = "center";
      emptyMsg.style.width = "100%";
      emptyMsg.style.color = "#ff66cc";
      emptyMsg.textContent = "Aucun utilisateur en ligne pour le moment...";
      carousel.appendChild(emptyMsg);
    }
  });
});

// --- Gestion des boutons du carrousel ---
carousel.addEventListener("click", (e) => {
  const card = e.target.closest(".card");
  if (!card) return;
  const targetUid = card.dataset.uid;
  const currentUser = auth.currentUser;
  if (!currentUser || !targetUid) return;

  // Chat
  if (e.target.closest(".btn-chat")) {
    window.location.href = `Chat.html?uid=${targetUid}`;
  }

  // Like
  if (e.target.closest(".btn-like")) {
    update(ref(db, `users/${targetUid}/likes/${currentUser.uid}`), true);
    e.target.classList.add("active");
  }

  // Favoris
  if (e.target.closest(".btn-fav")) {
    update(ref(db, `users/${currentUser.uid}/favoris/${targetUid}`), true);
    e.target.classList.add("active");
  }
});

// --- Clic sur la photo du mini profil ---
miniProfilePic.addEventListener("click", () => {
  window.location.href = "page2.html";
});
</script>
</body>
</html>
