<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Authentique</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500&display=swap" rel="stylesheet">
<style>
* { margin:0; padding:0; box-sizing:border-box; }
html,body { width:100%; height:100%; font-family:'Orbitron',sans-serif; background:url('planete-romantique.jpg') no-repeat center center/cover; color:white; overflow-x:hidden; }
.header { display:flex; justify-content:space-between; align-items:center; padding:20px; position:sticky; top:0; background:rgba(0,0,0,0.5); z-index:10; }
.header h1 { color:#ff66cc; font-size:1.5em; }
.logout-btn { background:none; border:1px solid #ff66cc; color:#ff66cc; border-radius:6px; padding:5px 10px; cursor:pointer; transition:0.3s; }
.logout-btn:hover { background:#ff66cc; color:white; }

.cardsContainer { display:flex; flex-wrap:wrap; justify-content:center; gap:20px; padding:20px; }
.card { width:160px; background:rgba(0,0,0,0.4); border:1px solid #ff66cc; border-radius:10px; padding:10px; text-align:center; box-shadow:0 0 12px rgba(255,102,204,0.4); transition:transform .3s, box-shadow .3s; cursor:pointer; }
.card:hover { transform:scale(1.05); box-shadow:0 0 20px rgba(255,102,204,0.7); }
.card img { width:100%; height:160px; object-fit:cover; border-radius:8px; border:2px solid #ff66cc; }
.card h2 { font-size:1.1em; color:#ff66cc; margin-top:5px; }
.card p { font-size:0.9em; color:white; }
.card .actions { display:flex; justify-content:center; gap:10px; margin-top:8px; }
.card .actions div { width:30px; height:30px; display:flex; align-items:center; justify-content:center; border-radius:50%; background:rgba(255,255,255,0.1); border:1px solid #ff66cc; color:#ff66cc; cursor:pointer; font-size:1em; transition:.2s; }
.card .actions div:hover { transform:scale(1.2); }
.actions .like.active { background:#ff66cc; color:white; box-shadow:0 0 8px #ff66cc; }
.actions .fav.active { background:#ffea00; color:#333; box-shadow:0 0 8px #ffea00; }
</style>
</head>
<body>

<div class="header">
  <h1>Authentique üí´</h1>
  <button class="logout-btn" id="logoutBtn">D√©connexion</button>
</div>

<div class="cardsContainer" id="cardsContainer"></div>

<script type="module">
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
import { getDatabase, ref, get, update, set } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";
import { app } from "./firebase.js";

const auth = getAuth(app);
const db = getDatabase(app);

const cardsContainer = document.getElementById("cardsContainer");
const logoutBtn = document.getElementById("logoutBtn");

let currentUserUid = null;

// --- Auth check ---
onAuthStateChanged(auth, async user => {
  if (!user) {
    window.location.href = "inscription.html";
    return;
  }
  currentUserUid = user.uid;
  await loadUsers();
});

// --- D√©connexion ---
logoutBtn.addEventListener("click", async () => {
  await signOut(auth);
  window.location.href = "inscription.html";
});

// --- Charger les profils ---
async function loadUsers() {
  const snap = await get(ref(db, "users"));
  if (!snap.exists()) return;

  const users = snap.val();
  cardsContainer.innerHTML = "";

  Object.entries(users).forEach(([uid, data]) => {
    if (uid === currentUserUid) return;

    const imgSrc = data.photos && data.photos.length > 0 ? data.photos[0] : "https://i.pravatar.cc/150?img=12";
    const card = document.createElement("div");
    card.classList.add("card");
    card.innerHTML = `
      <img src="${imgSrc}" alt="photo">
      <h2>${data.pseudo || "Utilisateur"}</h2>
      <p>${data.age ? data.age + " ans" : ""}</p>
      <div class="actions">
        <div class="chat" title="Message">üí¨</div>
        <div class="like" title="Like">üíñ</div>
        <div class="fav" title="Favoris">‚≠êÔ∏è</div>
      </div>
    `;

    // --- Ouvrir profil complet au clic sur la carte ---
    card.addEventListener("click", e => {
      if (!e.target.classList.contains("chat") && !e.target.classList.contains("like") && !e.target.classList.contains("fav")) {
        window.location.href = `profilcard.html?uid=${uid}`;
      }
    });

    const btnLike = card.querySelector(".like");
    const btnFav = card.querySelector(".fav");
    const btnChat = card.querySelector(".chat");

    // --- Initialiser √©tats like/fav ---
    get(ref(db, `users/${uid}/likes/${currentUserUid}`)).then(likeSnap => {
      if (likeSnap.exists()) btnLike.classList.add("active");
    });
    get(ref(db, `users/${currentUserUid}/favoris/${uid}`)).then(favSnap => {
      if (favSnap.exists()) btnFav.classList.add("active");
    });

    // --- Like ---
    btnLike.addEventListener("click", async e => {
      e.stopPropagation();
      btnLike.classList.toggle("active");
      const liked = btnLike.classList.contains("active");
      if (liked)
        await update(ref(db, `users/${uid}/likes/${currentUserUid}`), { liked: true });
      else
        await set(ref(db, `users/${uid}/likes/${currentUserUid}`), null);
    });

    // --- Favoris ---
    btnFav.addEventListener("click", async e => {
      e.stopPropagation();
      btnFav.classList.toggle("active");
      const favored = btnFav.classList.contains("active");
      if (favored)
        await update(ref(db, `users/${currentUserUid}/favoris/${uid}`), { fav: true });
      else
        await set(ref(db, `users/${currentUserUid}/favoris/${uid}`), null);
    });

    // --- Chat ---
    btnChat.addEventListener("click", e => {
      e.stopPropagation();
      window.location.href = `profilcard.html?uid=${uid}&chat=1`;
    });

    cardsContainer.appendChild(card);
  });
}
</script>
</body>
</html>
