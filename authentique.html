<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>Profils avec Favoris et Chat</title>
<style>
  /* Styles existants non modifiÃ©s */
  body {
    font-family: Arial, sans-serif;
    background: #111;
    color: white;
    margin: 0;
    padding: 0;
  }

  .card {
    background: #222;
    border-radius: 10px;
    padding: 15px;
    margin: 20px;
    display: inline-block;
    width: 220px;
    vertical-align: top;
    position: relative;
  }

  .card img {
    width: 100%;
    border-radius: 10px;
  }

  .btn-group {
    display: flex;
    justify-content: space-around;
    margin-top: 10px;
  }

  .btn {
    cursor: pointer;
    background: transparent;
    border: none;
    font-size: 18px;
    color: white;
    transition: color 0.3s;
  }

  .btn:hover {
    color: #f08;
  }

  /* Bouton favori style */
  .btn-fav {
    color: white;
    font-size: 24px;
    user-select: none;
  }
  .btn-fav.active {
    color: gold;
  }

  /* Sidebar gauche */
  .sidebar {
    position: fixed;
    top: 0; left: 0;
    width: 60px;
    height: 100%;
    background: #333;
    overflow-y: auto;
    padding-top: 10px;
    z-index: 1000;
  }

  .mini-profile {
    width: 50px;
    height: 50px;
    margin: 8px auto;
    border-radius: 50%;
    overflow: hidden;
    border: 2px solid white;
    cursor: move;
    position: absolute;
  }

  .mini-profile img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  /* Chat box */
  .chat-box {
    position: fixed;
    bottom: 0;
    right: 10px;
    width: 300px;
    max-height: 400px;
    background: #000;
    border: 1px solid #444;
    border-radius: 10px 10px 0 0;
    overflow: hidden;
    display: none;
    flex-direction: column;
    z-index: 999;
  }

  .chat-header {
    background: #222;
    padding: 8px;
    font-weight: bold;
    cursor: pointer;
    user-select: none;
  }

  .chat-messages {
    flex: 1;
    padding: 10px;
    overflow-y: auto;
    font-size: 14px;
  }

  .chat-input-container {
    display: flex;
    border-top: 1px solid #444;
  }

  .chat-input {
    flex: 1;
    padding: 8px;
    border: none;
    outline: none;
    font-size: 14px;
    background: #111;
    color: white;
  }

  .chat-send-btn {
    background: #222;
    border: none;
    color: white;
    padding: 0 15px;
    cursor: pointer;
  }

  .chat-send-btn:hover {
    background: #444;
  }

</style>
</head>
<body>

<!-- Sidebar mini profils -->
<div class="sidebar" id="sidebar"></div>

<!-- Profils principaux -->
<div id="profiles-container">
  <!-- Exemple de profil, en vrai ce sera dynamique -->
  <div class="card" data-id="1" data-name="Alice" data-img="https://i.pravatar.cc/220?img=1">
    <img src="https://i.pravatar.cc/220?img=1" alt="Alice" />
    <h3>Alice</h3>
    <div class="btn-group">
      <button class="btn btn-fav" title="Ajouter aux favoris" aria-label="Favori">â˜†</button>
      <button class="btn btn-chat" title="Ouvrir chat" aria-label="Chat">ðŸ“¬</button>
    </div>
  </div>

  <div class="card" data-id="2" data-name="Bob" data-img="https://i.pravatar.cc/220?img=2">
    <img src="https://i.pravatar.cc/220?img=2" alt="Bob" />
    <h3>Bob</h3>
    <div class="btn-group">
      <button class="btn btn-fav" title="Ajouter aux favoris" aria-label="Favori">â˜†</button>
      <button class="btn btn-chat" title="Ouvrir chat" aria-label="Chat">ðŸ“¬</button>
    </div>
  </div>

  <div class="card" data-id="3" data-name="Clara" data-img="https://i.pravatar.cc/220?img=3">
    <img src="https://i.pravatar.cc/220?img=3" alt="Clara" />
    <h3>Clara</h3>
    <div class="btn-group">
      <button class="btn btn-fav" title="Ajouter aux favoris" aria-label="Favori">â˜†</button>
      <button class="btn btn-chat" title="Ouvrir chat" aria-label="Chat">ðŸ“¬</button>
    </div>
  </div>
</div>

<!-- Chat box -->
<div class="chat-box" id="chat-box">
  <div class="chat-header" id="chat-header">Chat</div>
  <div class="chat-messages" id="chat-messages"></div>
  <div class="chat-input-container">
    <input type="text" id="chat-input" class="chat-input" placeholder="Ã‰crire un message..." />
    <button id="chat-send-btn" class="chat-send-btn">Envoyer</button>
  </div>
</div>

<script>
  // --- VARIABLES ---
  const profilesContainer = document.getElementById('profiles-container');
  const sidebar = document.getElementById('sidebar');
  const chatBox = document.getElementById('chat-box');
  const chatHeader = document.getElementById('chat-header');
  const chatMessages = document.getElementById('chat-messages');
  const chatInput = document.getElementById('chat-input');
  const chatSendBtn = document.getElementById('chat-send-btn');

  let currentChatId = null;

  // --- FONCTION : crÃ©er un mini-profil dans la sidebar ---
  function createMiniProfile(profileData) {
    // Check if mini-profile exists
    if(document.querySelector('.mini-profile[data-id="'+profileData.id+'"]')) return;

    const mini = document.createElement('div');
    mini.classList.add('mini-profile');
    mini.setAttribute('data-id', profileData.id);
    mini.style.top = '10px';
    mini.style.left = '5px';

    const img = document.createElement('img');
    img.src = profileData.img;
    img.alt = profileData.name;

    mini.appendChild(img);
    sidebar.appendChild(mini);

    // Enable drag & drop
    mini.onmousedown = dragMouseDown;

    // Initial position relative to sidebar
    mini.style.position = 'absolute';
    mini.style.top = '10px';
    mini.style.left = '5px';
  }

  // --- DRAG & DROP pour mini profils ---
  let dragElem = null;
  let posX = 0, posY = 0, mouseX = 0, mouseY = 0;

  function dragMouseDown(e) {
    dragElem = e.currentTarget;
    e.preventDefault();
    mouseX = e.clientX;
    mouseY = e.clientY;
    document.onmouseup = closeDragElement;
    document.onmousemove = elementDrag;
  }

  function elementDrag(e) {
    e.preventDefault();
    if(!dragElem) return;
    posX = mouseX - e.clientX;
    posY = mouseY - e.clientY;
    mouseX = e.clientX;
    mouseY = e.clientY;

    let newTop = dragElem.offsetTop - posY;
    let newLeft = dragElem.offsetLeft - posX;

    // Limiter dans la fenÃªtre
    const sidebarRect = sidebar.getBoundingClientRect();
    const elemRect = dragElem.getBoundingClientRect();

    if(newTop < 0) newTop = 0;
    if(newLeft < 0) newLeft = 0;
    if(newTop + elemRect.height > window.innerHeight) newTop = window.innerHeight - elemRect.height;
    if(newLeft + elemRect.width > window.innerWidth) newLeft = window.innerWidth - elemRect.width;

    dragElem.style.top = newTop + "px";
    dragElem.style.left = newLeft + "px";
  }

  function closeDragElement() {
    document.onmouseup = null;
    document.onmousemove = null;
    dragElem = null;
  }

  // --- FAVORIS ---
  function toggleFavorite(btn, profileId) {
    btn.classList.toggle('active');
    if(btn.classList.contains('active')) {
      btn.textContent = 'â˜…'; // pleine
    } else {
      btn.textContent = 'â˜†'; // vide
    }
    // Stockage local (optionnel)
    const favs = JSON.parse(localStorage.getItem('favoris') || '{}');
    if(btn.classList.contains('active')) {
      favs[profileId] = true;
    } else {
      delete favs[profileId];
    }
    localStorage.setItem('favoris', JSON.stringify(favs));
  }

  // --- CHARGER FAVORIS DU LOCALSTORAGE AU DEMARRAGE ---
  function loadFavorites() {
    const favs = JSON.parse(localStorage.getItem('favoris') || '{}');
    document.querySelectorAll('.card').forEach(card => {
      const favBtn = card.querySelector('.btn-fav');
      const id = card.getAttribute('data-id');
      if(favs[id]) {
        favBtn.classList.add('active');
        favBtn.textContent = 'â˜…';
      } else {
        favBtn.classList.remove('active');
        favBtn.textContent = 'â˜†';
      }
    });
  }

  // --- CHAT ---

  // Charge historique chat depuis localStorage
  function loadChatHistory(profileId) {
    const history = JSON.parse(localStorage.getItem('chat_' + profileId) || '[]');
    chatMessages.innerHTML = '';
    history.forEach(msg => {
      const div = document.createElement('div');
      div.textContent = msg;
      chatMessages.appendChild(div);
    });
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  // Sauvegarde message dans localStorage
  function saveChatMessage(profileId, msg) {
    const history = JSON.parse(localStorage.getItem('chat_' + profileId) || '[]');
    history.push(msg);
    localStorage.setItem('chat_' + profileId, JSON.stringify(history));
  }

  // Ouvrir chat pour un profil
  function openChat(profileId, profileName) {
    currentChatId = profileId;
    chatHeader.textContent = "Chat avec " + profileName;
    chatBox.style.display = 'flex';
    loadChatHistory(profileId);
    chatInput.focus();
  }

  // Fermer chat au clic header
  chatHeader.onclick = () => {
    chatBox.style.display = 'none';
    currentChatId = null;
  };

  // Envoyer message
  chatSendBtn.onclick = () => {
    if(!currentChatId) return;
    const msg = chatInput.value.trim();
    if(msg === '') return;
    const text = "Moi: " + msg;
    const div = document.createElement('div');
    div.textContent = text;
    chatMessages.appendChild(div);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    saveChatMessage(currentChatId, text);
    chatInput.value = '';
  };

  chatInput.addEventListener('keydown', e => {
    if(e.key === 'Enter') {
      chatSendBtn.click();
    }
  });

  // --- INIT ---
  document.querySelectorAll('.card').forEach(card => {
    const profileId = card.getAttribute('data-id');
    const profileName = card.getAttribute('data-name');
    const profileImg = card.getAttribute('data-img');

    // Ajouter mini profil dans sidebar
    createMiniProfile({id: profileId, name: profileName, img: profileImg});

    // Favori
    const favBtn = card.querySelector('.btn-fav');
    favBtn.addEventListener('click', () => toggleFavorite(favBtn, profileId));

    // Chat
    const chatBtn = card.querySelector('.btn-chat');
    chatBtn.addEventListener('click', () => openChat(profileId, profileName));
  });

  // Charger favoris au dÃ©marrage
  loadFavorites();
</script>

</body>
</html>
