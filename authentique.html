<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>Authentique</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500&display=swap" rel="stylesheet">
<style>
* { box-sizing:border-box; margin:0; padding:0; }
html,body { height:100%; width:100%; font-family:'Orbitron',sans-serif; background:#000 url('planete-romantique.jpg') no-repeat center/cover; color:white; overflow:hidden; }
#myProfile { text-align:center; margin-top:15px; cursor:pointer; }
#myProfile img { width:90px; height:90px; border-radius:50%; border:3px solid #ff66cc; box-shadow:0 0 15px #ff66cc; object-fit:cover; }
#myProfile div { color:#ff66cc; margin-top:8px; }

/* Carousel */
.carousel-container { height:calc(100% - 180px); display:flex; align-items:center; justify-content:center; overflow:hidden; }
.carousel { display:flex; overflow-x:auto; gap:30px; padding:20px; scroll-snap-type:x mandatory; }
.carousel::-webkit-scrollbar { display:none; }
.card { flex:0 0 140px; background:rgba(0,0,0,0.5); border-radius:15px; padding:10px; text-align:center; position:relative; scroll-snap-align:center; transition:transform .2s; }
.card img { width:90px; height:90px; border-radius:50%; object-fit:cover; margin-bottom:8px; border:3px solid #ff66cc; box-shadow:0 0 10px #ff66cc; cursor:pointer; }
.card .name { font-size:1.1em; color:#ff66cc; margin-bottom:5px; }
.btns { display:flex; justify-content:center; gap:6px; }
.btn-like,.btn-fav,.btn-chat { width:28px; height:28px; border-radius:50%; border:1px solid #ff66cc; display:flex; align-items:center; justify-content:center; color:#ff66cc; background:rgba(255,255,255,0.1); cursor:pointer; transition:transform .1s; }
.btn-like.active { background:#ff66cc; color:white; box-shadow:0 0 10px #ff66cc; }
.btn-fav.active { background:#ffea00; color:#333; box-shadow:0 0 10px #ffea00; }
.btn-like:hover,.btn-fav:hover,.btn-chat:hover { transform:scale(1.2); }

/* Mini profils */
#miniProfilesContainer { position:fixed; top:80px; left:10px; z-index:99; display:flex; flex-wrap:wrap; gap:10px; }
.miniProfileCircle { width:55px; height:55px; border-radius:50%; overflow:hidden; border:2px solid #ff66cc; box-shadow:0 0 12px #ff66cc; position:absolute; cursor:grab; transition:none; }
.miniProfileCircle img { width:100%; height:100%; object-fit:cover; }
.miniRemove { position:absolute; top:-6px; right:-6px; background:#ff66cc; color:white; width:16px; height:16px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:0.6em; cursor:pointer; }

/* Bouton Mes Crush */
#favoritesBtn { position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:#ffea00; color:#333; border:none; border-radius:25px; padding:10px 20px; cursor:pointer; font-weight:bold; box-shadow:0 0 10px #ffea00; }
</style>
</head>
<body>

<div id="myProfile">
  <img id="miniProfilePic" src="" alt="Moi">
  <div id="pseudoMini">Utilisateur</div>
</div>

<div class="carousel-container">
  <div id="carousel" class="carousel"></div>
</div>

<div id="miniProfilesContainer"></div>
<button id="favoritesBtn">Mes Crush</button>

<script type="module">
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
import { getDatabase, ref, onValue, set, update, get, onDisconnect } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";
import { app } from "./firebase.js";

const auth = getAuth(app);
const db = getDatabase(app);

const miniProfilePic=document.getElementById("miniProfilePic");
const pseudoMini=document.getElementById("pseudoMini");
const carousel=document.getElementById("carousel");
const miniProfilesContainer=document.getElementById("miniProfilesContainer");

let currentUserUid=null;

onAuthStateChanged(auth,async user=>{
  if(!user){window.location.href="inscription.html";return;}
  currentUserUid=user.uid;
  const uRef=ref(db,"users/"+currentUserUid);
  await update(uRef,{online:true});
  onDisconnect(ref(db,"users/"+currentUserUid+"/online")).set(false);

  onValue(uRef,snap=>{
    if(snap.exists()){
      const d=snap.val();
      pseudoMini.textContent=d.pseudo||"Moi";
      miniProfilePic.src=(d.photos&&d.photos[0])?d.photos[0]:"https://i.pravatar.cc/150?img=12";
    }
  });

  onValue(ref(db,"users"),snap=>{
    carousel.innerHTML="";
    if(!snap.exists()) return;
    const data=snap.val();
    Object.entries(data).forEach(([uid,u])=>{
      if(uid===currentUserUid||!u.online) return;
      const card=document.createElement("div");
      card.className="card";
      card.dataset.uid=uid;
      card.innerHTML=`
        <img src="${u.photos && u.photos[0]?u.photos[0]:"https://i.pravatar.cc/150?img=12"}">
        <div class="name">${u.pseudo||"Utilisateur"}</div>
        <div class="btns">
          <div class="btn-chat">üí¨</div>
          <div class="btn-like">üíñ</div>
          <div class="btn-fav">‚≠êÔ∏è</div>
        </div>`;
      carousel.appendChild(card);
    });
  });
});

// --- Like / Fav + MiniProfile ---
carousel.addEventListener("click",async e=>{
  const card=e.target.closest(".card");
  if(!card) return;
  const uid=card.dataset.uid;
  const btnLike=e.target.closest(".btn-like");
  const btnFav=e.target.closest(".btn-fav");

  if(btnLike){
    btnLike.classList.toggle("active");
    await set(ref(db,`users/${uid}/likes/${currentUserUid}`),btnLike.classList.contains("active"));
    addMini(card);
  }
  if(btnFav){
    btnFav.classList.toggle("active");
    await set(ref(db,`users/${currentUserUid}/favoris/${uid}`),btnFav.classList.contains("active"));
    addMini(card);
  }
});

function addMini(card){
  const uid=card.dataset.uid;
  if(document.querySelector(`.miniProfileCircle[data-uid="${uid}"]`)) return;
  const circle=document.createElement("div");
  circle.className="miniProfileCircle";
  circle.dataset.uid=uid;
  circle.style.left="20px";
  circle.style.top="80px";
  const img=card.querySelector("img").cloneNode();
  circle.appendChild(img);
  const x=document.createElement("div");
  x.className="miniRemove";
  x.textContent="√ó";
  x.onclick=()=>circle.remove();
  circle.appendChild(x);

  let offsetX,offsetY,drag=false;
  circle.addEventListener("mousedown",e=>{
    drag=true;
    offsetX=e.clientX-parseFloat(circle.style.left);
    offsetY=e.clientY-parseFloat(circle.style.top);
    circle.style.cursor="grabbing";
  });
  document.addEventListener("mousemove",e=>{
    if(!drag)return;
    circle.style.left=e.clientX-offsetX+"px";
    circle.style.top=e.clientY-offsetY+"px";
  });
  document.addEventListener("mouseup",()=>{drag=false;circle.style.cursor="grab";});
  miniProfilesContainer.appendChild(circle);
}
</script>
</body>
</html>
