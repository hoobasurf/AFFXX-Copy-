<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>Profil Card</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500&display=swap" rel="stylesheet">
<style>
* { box-sizing:border-box; margin:0; padding:0; }
html, body {
  height:100%; width:100%;
  font-family:'Orbitron',sans-serif;
  background:url('planete-romantique.jpg') no-repeat center center/cover;
  color:white;
  overflow-y:auto;
}
body::before {
  content:"";
  position:fixed; top:0; left:0;
  width:100%; height:100%;
  background: radial-gradient(circle at center, rgba(255,0,255,0.05), transparent 70%);
  z-index:1; pointer-events:none;
}

/* === Barre de navigation fixe === */
.navbar {
  position:fixed;
  top:0; left:0; width:100%;
  height:60px;
  display:flex; align-items:center; justify-content:space-between;
  background:rgba(0,0,0,0.5);
  backdrop-filter: blur(4px);
  border-bottom:1px solid rgba(255,102,204,0.3);
  padding:0 20px;
  z-index:100;
}
.navbar button {
  background:none; border:none;
  color:#ff66cc; font-size:1em;
  cursor:pointer;
  transition:color .3s, transform .3s;
}
.navbar button:hover { color:#ff99e6; transform:scale(1.1); }
.navbar .title {
  flex:1; text-align:center;
  color:#ff66cc; font-size:1.2em;
  text-shadow:0 0 8px #ff66cc;
}

/* === Profil principal === */
#profileCard {
  position:relative; z-index:2;
  padding:100px 20px 20px 20px; /* marge top pour laisser place √† la navbar */
  text-align:center;
}
#profileCard img {
  width:120px; height:120px;
  border-radius:50%;
  border:3px solid #ff66cc;
  box-shadow:0 0 15px #ff66cc;
  object-fit:cover; background:#222;
}
.name {
  margin-top:10px; font-size:1.5em; color:#ff66cc;
}
.btns {
  display:flex; justify-content:center; gap:10px; margin-top:15px;
}
.btn-like, .btn-fav, .btn-chat {
  width:40px; height:40px; border-radius:50%;
  background:rgba(255,255,255,0.1);
  border:1px solid #ff66cc; color:#ff66cc;
  display:flex; align-items:center; justify-content:center;
  font-size:1.2em; cursor:pointer;
  transition: all .18s;
}
.btn-like.active { background:#ff66cc; color:white; box-shadow:0 0 12px #ff66cc; }
.btn-fav.active { background:#ffea00; color:#333; box-shadow:0 0 12px #ffea00; }

/* === Chat modal === */
#chatModal {
  display:none;
  position:fixed; top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,0.85);
  z-index:200;
  padding:20px; box-sizing:border-box;
}
#chatModal .closeChat {
  position:absolute; top:12px; right:12px;
  color:#ff66cc; font-size:22px; cursor:pointer;
}
#chatBox {
  margin-top:50px; margin-bottom:10px;
  max-height:70vh; overflow-y:auto;
  border:1px solid rgba(255,102,204,0.15);
  padding:10px; border-radius:8px;
  background:rgba(0,0,0,0.2);
}
.msg {
  padding:6px 8px; margin-bottom:8px;
  border-radius:6px; font-size:14px;
}
.msg.me {
  background:rgba(255,102,204,0.18);
  align-self:flex-end; color:#fff;
}
.msg.them {
  background:rgba(255,255,255,0.04); color:#fff;
}
#chatInput {
  display:flex; gap:8px; margin-top:10px; align-items:center;
}
#msgText {
  flex:1; padding:8px 10px; border-radius:8px;
  border:1px solid rgba(255,102,204,0.15);
  background:rgba(0,0,0,0.4); color:white;
  outline:none; font-family:'Orbitron',sans-serif;
  -webkit-text-size-adjust:100%;
  font-size:16px;
}
#sendMsgBtn {
  background:#ff66cc; border:none;
  padding:8px 12px; border-radius:8px;
  color:white; cursor:pointer;
}
</style>
</head>
<body>

<!-- ‚úÖ Barre de navigation -->
<div class="navbar">
  <button id="backBtn">‚¨Ö Authentique</button>
  <div class="title">Profil</div>
  <div style="width:60px;"></div> <!-- espace pour √©quilibre -->
</div>

<!-- === Profil principal === -->
<div id="profileCard">
  <img id="profilePic" src="" alt="Profil" />
  <div class="name" id="profileName">Utilisateur</div>
  <div class="btns">
    <div class="btn-chat" title="Chat">üí¨</div>
    <div class="btn-like" title="Like">üíñ</div>
    <div class="btn-fav" title="Favoris">‚≠êÔ∏è</div>
  </div>
</div>

<!-- === Chat modal === -->
<div id="chatModal">
  <div class="closeChat">‚úñ</div>
  <div id="chatBox"></div>
  <div id="chatInput">
    <input id="msgText" type="text" placeholder="√âcris ton message..." autocomplete="off" />
    <button id="sendMsgBtn">Envoyer</button>
  </div>
</div>

<script type="module">
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
import { getDatabase, ref, get, set, push, onValue, onChildAdded } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";
import { app } from "./firebase.js";

const auth = getAuth(app);
const db = getDatabase(app);

const urlParams = new URLSearchParams(window.location.search);
const targetUid = urlParams.get('uid');

const profilePic = document.getElementById("profilePic");
const profileName = document.getElementById("profileName");
const btnLike = document.querySelector(".btn-like");
const btnFav = document.querySelector(".btn-fav");
const btnChat = document.querySelector(".btn-chat");

const chatModal = document.getElementById("chatModal");
const closeChat = document.querySelector(".closeChat");
const chatBox = document.getElementById("chatBox");
const msgText = document.getElementById("msgText");
const sendMsgBtn = document.getElementById("sendMsgBtn");

const backBtn = document.getElementById("backBtn");
backBtn.addEventListener("click", () => {
  window.location.href = "authentique.html";
});

let currentUserUid = null;

function setImgSafe(imgEl, src) {
  imgEl.src = src || ("https://i.pravatar.cc/150?u=" + (targetUid || "default"));
  imgEl.onerror = () => { imgEl.src = "https://i.pravatar.cc/150?u=fallback"; };
}

onAuthStateChanged(auth, async user => {
  if (!user) { window.location.href = "inscription.html"; return; }
  currentUserUid = user.uid;

  if(!targetUid){
    window.location.href = "authentique.html";
    return;
  }

  // R√©cup√©ration du profil
  try {
    const snapshot = await get(ref(db, `users/${targetUid}`));
    if(snapshot.exists()){
      const data = snapshot.val();
      profileName.textContent = data.pseudo || "Utilisateur";
      const photo = (data.photos && data.photos.length > 0) ? data.photos[0] : null;
      setImgSafe(profilePic, photo);
    } else {
      profileName.textContent = "Profil introuvable";
      setImgSafe(profilePic, null);
    }
  } catch(err){
    console.error("Erreur lecture profil:", err);
    setImgSafe(profilePic, null);
  }

  // === Synchronisation temps r√©el ===
  onValue(ref(db, `users/${targetUid}/likes/${currentUserUid}`), snap => {
    btnLike.classList.toggle("active", snap.exists() && snap.val() === true);
  });
  onValue(ref(db, `users/${currentUserUid}/favoris/${targetUid}`), snap => {
    btnFav.classList.toggle("active", snap.exists() && snap.val() === true);
  });

  onChildAdded(ref(db, `messages/${currentUserUid}/${targetUid}`), snapshot => {
    const m = snapshot.val();
    if(m) appendMessageToBox(m);
  });
});

// === Actions Like / Fav ===
btnLike.addEventListener("click", async () => {
  if(!currentUserUid || !targetUid) return;
  const likeRef = ref(db, `users/${targetUid}/likes/${currentUserUid}`);
  const isActive = btnLike.classList.contains("active");
  await set(likeRef, !isActive);
});
btnFav.addEventListener("click", async () => {
  if(!currentUserUid || !targetUid) return;
  const favRef = ref(db, `users/${currentUserUid}/favoris/${targetUid}`);
  const isActive = btnFav.classList.contains("active");
  await set(favRef, !isActive);
});

// === Chat ===
btnChat.addEventListener("click", () => {
  chatModal.style.display = "block";
  chatBox.innerHTML = "";
  loadMessages();
});
closeChat.addEventListener("click", () => { chatModal.style.display = "none"; });

function appendMessageToBox(m){
  const div = document.createElement("div");
  div.className = "msg " + (m.from === currentUserUid ? "me" : "them");
  div.textContent = (m.from === currentUserUid ? "Moi: " : "") + (m.text || "");
  chatBox.appendChild(div);
  chatBox.scrollTop = chatBox.scrollHeight;
}

async function loadMessages(){
  try {
    const snap = await get(ref(db, `messages/${currentUserUid}/${targetUid}`));
    if(snap.exists()){
      Object.values(snap.val()).forEach(m => appendMessageToBox(m));
    }
  } catch(err){ console.error("Erreur loadMessages:", err); }
}

sendMsgBtn.addEventListener("click", async ()=>{
  const text = msgText.value.trim();
  if(!text || !currentUserUid || !targetUid) return;
  const msg = { from: currentUserUid, to: targetUid, text, timestamp: Date.now() };
  await set(push(ref(db, `messages/${currentUserUid}/${targetUid}`)), msg);
  await set(push(ref(db, `messages/${targetUid}/${currentUserUid}`)), msg);
  msgText.value = "";
  appendMessageToBox(msg);
});
</script>
</body>
</html>
